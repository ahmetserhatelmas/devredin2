<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devren ƒ∞lanlarƒ± - Devredin</title>
    <link rel="stylesheet" href="styles.css?v=10">
    <link rel="stylesheet" href="listings.css?v=19">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="listings-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo">
                    <a href="index.html" class="logo-main">devredin</a>
                    <span class="logo-divider">|</span>
                    <a href="franchise.html" class="logo-sub">fr.</a>
                </div>
                
                <ul class="nav-menu">
                    <li><a href="listings.html" class="nav-link active">ƒ∞≈ületme Devral</a></li>
                    <li><a href="add-listing.html" class="nav-link">ƒ∞≈ületmeni Devret</a></li>
                    <li id="panelLink" style="display: none;"><a href="panel/" class="nav-link">Panel</a></li>
                    <li><a href="blog.html" class="nav-link">Blog</a></li>
                </ul>
                
                <div class="nav-actions">
                    <button class="nav-icon-btn search-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                    
                    <!-- Auth Menu -->
                    <div class="auth-menu" id="authMenu">
                        <button class="auth-icon-btn" id="authBtn" onclick="toggleAuthDropdown()">
                            <svg id="authIconGuest" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span id="authIconUser" class="user-initials" style="display:none;">AE</span>
                        </button>
                        <div class="auth-dropdown" id="authDropdown">
                            <!-- Not logged in -->
                            <div id="authButtons">
                                <a href="login.html" class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                        <polyline points="10 17 15 12 10 7"></polyline>
                                        <line x1="15" y1="12" x2="3" y2="12"></line>
                                    </svg>
                                    Giri≈ü Yap
                                </a>
                                <a href="login.html?register=true" class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="20" y1="8" x2="20" y2="14"></line>
                                        <line x1="23" y1="11" x2="17" y2="11"></line>
                                    </svg>
                                    √úye Ol
                                </a>
                            </div>
                            <!-- Logged in -->
                            <div id="userMenu" style="display: none;">
                                <div class="dropdown-header">
                                    <div class="dropdown-avatar" id="dropdownAvatar">AE</div>
                                    <span class="dropdown-name" id="dropdownName">Kullanƒ±cƒ±</span>
                                </div>
                                <a href="profile.html" class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                    Profil
                                </a>
                                <a href="panel/" class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="7" height="7"></rect>
                                        <rect x="14" y="3" width="7" height="7"></rect>
                                        <rect x="14" y="14" width="7" height="7"></rect>
                                        <rect x="3" y="14" width="7" height="7"></rect>
                                    </svg>
                                    Panel
                                </a>
                                <a href="settings.html" class="dropdown-item">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                    Ayarlar
                                </a>
                                <div class="dropdown-divider"></div>
                                <button onclick="logout()" class="dropdown-item logout">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                        <polyline points="16 17 21 12 16 7"></polyline>
                                        <line x1="21" y1="12" x2="9" y2="12"></line>
                                    </svg>
                                    √áƒ±kƒ±≈ü Yap
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <a href="add-listing.html" class="btn btn-primary-nav">√úcretsiz ƒ∞lan Olu≈ütur</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="listings-main">
        <!-- Sidebar Filter -->
        <aside class="filter-sidebar" id="filterSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <a href="index.html" class="logo-main">devredin</a>
                    <span class="logo-divider">|</span>
                    <a href="franchise.html" class="logo-sub">fr.</a>
                </div>
                <button class="close-sidebar" onclick="toggleSidebar()">‚úï</button>
            </div>
            
            <div class="sidebar-search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" placeholder="Arama..." id="sidebarSearch">
            </div>
            
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="filters" onclick="switchSidebarTab('filters')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    </svg>
                </button>
                <button class="sidebar-tab" data-tab="sort" onclick="switchSidebarTab('sort')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <polyline points="19 12 12 19 5 12"></polyline>
                    </svg>
                </button>
                <button class="sidebar-tab" data-tab="saved" onclick="switchSidebarTab('saved')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Filters Panel -->
            <div class="sidebar-panel active" id="filtersPanel">
                <h3 class="panel-title">Filtreler</h3>
                
                <div class="filter-group">
                    <button class="filter-accordion" onclick="toggleAccordion(this)">
                        <span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> Yer</span>
                        <svg class="accordion-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="filter-content">
                        <select id="filterCity" onchange="applyFilters()">
                            <option value="">T√ºm ≈ûehirler</option>
                        </select>
                        <select id="filterDistrict" onchange="applyFilters()">
                            <option value="">T√ºm ƒ∞l√ßeler</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-group">
                    <button class="filter-accordion" onclick="toggleAccordion(this)">
                        <span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg> Sekt√∂r</span>
                        <svg class="accordion-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="filter-content">
                        <select id="filterCategory" onchange="applyFilters()">
                            <option value="">T√ºm Sekt√∂rler</option>
                        </select>
                        <select id="filterSubcategory" onchange="applyFilters()">
                            <option value="">T√ºm Alt Kategoriler</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-group">
                    <button class="filter-accordion" onclick="toggleAccordion(this)">
                        <span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg> Fiyat</span>
                        <svg class="accordion-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="filter-content">
                        <div class="price-inputs">
                            <input type="number" id="minPrice" placeholder="Min ‚Ç∫" onchange="applyFilters()">
                            <span>-</span>
                            <input type="number" id="maxPrice" placeholder="Max ‚Ç∫" onchange="applyFilters()">
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <button class="filter-accordion" onclick="toggleAccordion(this)">
                        <span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line></svg> Geli≈ümi≈ü</span>
                        <svg class="accordion-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="filter-content">
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="filterFeatured" onchange="applyFilters()"> √ñne √áƒ±kan</label>
                            <label><input type="checkbox" id="filterFranchise" onchange="applyFilters()"> Franchise</label>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-apply" onclick="applyFilters()">Filtreleri Uygula</button>
            </div>
            
            <!-- Sort Panel -->
            <div class="sidebar-panel" id="sortPanel">
                <h3 class="panel-title">Sƒ±rala</h3>
                <div class="sort-options">
                    <button class="sort-option active" onclick="sortListings('date_desc')">
                        Tarih (√ñnce Yeni) <span>‚Üí</span>
                    </button>
                    <button class="sort-option" onclick="sortListings('date_asc')">
                        Tarih (√ñnce Eski) <span>‚Üí</span>
                    </button>
                    <button class="sort-option" onclick="sortListings('price_desc')">
                        Fiyat (Y√ºksekten D√º≈ü√ºƒüe) <span>‚Üí</span>
                    </button>
                    <button class="sort-option" onclick="sortListings('price_asc')">
                        Fiyat (D√º≈ü√ºkten Y√ºkseƒüe) <span>‚Üí</span>
                    </button>
                </div>
                <button class="btn btn-close-panel" onclick="toggleSidebar()">Kapat</button>
            </div>
            
            <!-- Saved Panel -->
            <div class="sidebar-panel" id="savedPanel">
                <h3 class="panel-title">Kayƒ±tlƒ± Filtrelerim</h3>
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <p>Hen√ºz kayƒ±tlƒ± filtreniz yok</p>
                    <span class="empty-hint">ƒ∞lan arama sayfasƒ±nda filtreleri uygulayƒ±p kaydet butonuna tƒ±klayarak filtre kaydedebilirsiniz.</span>
                </div>
                <button class="btn btn-close-panel" onclick="toggleSidebar()">Kapat</button>
            </div>
        </aside>

        <!-- Listings Section -->
        <section class="listings-section">
            <div class="listings-header">
                <div class="listings-title">
                    <h1>Devren ƒ∞lanlarƒ±</h1>
                    <span class="listings-count" id="listingsCount">0 sonu√ß g√∂steriliyor</span>
                </div>
                
                <div class="listings-controls">
                    <div class="search-box">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" placeholder="Arama..." id="searchInput" onkeyup="searchListings()">
                        <button class="btn btn-search-small">Ara</button>
                    </div>
                    
                    <div class="view-controls">
                        <button class="view-btn" onclick="toggleSidebar()" title="Filtreler">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            </svg>
                        </button>
                        <button class="view-btn" onclick="toggleSidebar()" title="Sƒ±rala">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <polyline points="19 12 12 19 5 12"></polyline>
                            </svg>
                        </button>
                        <button class="view-btn" title="Filtre Ayarlarƒ±">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="4" y1="21" x2="4" y2="14"></line>
                                <line x1="4" y1="10" x2="4" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12" y2="3"></line>
                                <line x1="20" y1="21" x2="20" y2="16"></line>
                                <line x1="20" y1="12" x2="20" y2="3"></line>
                            </svg>
                        </button>
                        <div class="view-divider"></div>
                        <button class="view-btn active" onclick="setView('list')" title="Liste">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </button>
                        <button class="view-btn" onclick="setView('grid')" title="Grid">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="listings-container" id="listingsContainer">
                <!-- Listings will be loaded here -->
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>ƒ∞lanlar y√ºkleniyor...</p>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section" id="mapSection">
            <div id="map"></div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="backend/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Global callback for Google Maps API
        function initGoogleMapsListings() {
            console.log('‚úÖ Google Maps API loaded for listings!');
            if (window.initListingsMap) {
                window.initListingsMap();
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC4r_aAIPvRAEGPqARc-Y9s-UstldmSqk&language=tr&callback=initGoogleMapsListings" async defer></script>
    <script src="listings-map.js?v=4"></script>
    <script src="script.js"></script>
    
    <!-- Google Maps -->
    <script>
        // Global variables for listing state (map variables are in listings-map.js)
        let currentListings = [];
        let currentSort = 'date_desc';
        let currentView = 'list';

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìã ƒ∞lanlar sayfasƒ± y√ºkleniyor...');
            // checkAuth removed - not needed for public listings page
            await loadFilters();
            await loadListings();
            // Map is initialized by Google Maps callback (initListingsMap)
        });
        
        // Auth functions loaded from js/auth.js
        // Map is initialized by listings-map.js via Google Maps callback

        // Load filters
        async function loadFilters() {
            try {
                // Cities - use name as value since city is now TEXT in listings table
                const { data: cities } = await supabase.from('cities').select('name').order('name');
                const citySelect = document.getElementById('filterCity');
                if (cities) {
                    citySelect.innerHTML = '<option value="">T√ºm ≈ûehirler</option>' +
                        cities.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                }

                // Categories
                const { data: categories } = await supabase.from('categories').select('id, name, icon').is('parent_id', null).order('name');
                const catSelect = document.getElementById('filterCategory');
                if (categories) {
                    catSelect.innerHTML = '<option value="">T√ºm Sekt√∂rler</option>' +
                        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Filter load error:', e);
            }
        }

        // Load listings
        async function loadListings() {
            try {
                console.log('üîÑ loadListings() ba≈üladƒ±');
                const container = document.getElementById('listingsContainer');
                if (!container) {
                    console.error('‚ùå listingsContainer bulunamadƒ±!');
                    return;
                }
                container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>ƒ∞lanlar y√ºkleniyor...</p></div>';

                const urlParams = new URLSearchParams(window.location.search);
                
                // URL'den parametreleri al
                const urlCity = urlParams.get('city');
                const urlSector = urlParams.get('sector');
                const urlCategory = urlParams.get('category');
                const urlMin = urlParams.get('min');
                const urlMax = urlParams.get('max');
                
                // Get city name from filter (city is now TEXT in listings table)
                let cityName = document.getElementById('filterCity').value;
                if (urlCity && !cityName) {
                    // T√ºrk√ße karakter d√∂n√º≈ü√ºm√º
                    const cityMap = {
                        'istanbul': 'ƒ∞stanbul',
                        'ankara': 'Ankara',
                        'izmir': 'ƒ∞zmir',
                        'bursa': 'Bursa',
                        'antalya': 'Antalya',
                        'kocaeli': 'Kocaeli',
                        'adana': 'Adana',
                        'gaziantep': 'Gaziantep',
                        'konya': 'Konya',
                        'mersin': 'Mersin'
                    };
                    cityName = cityMap[urlCity.toLowerCase()] || urlCity;
                    document.getElementById('filterCity').value = cityName;
                }
                
                // Kategori ID'sini bul (isim veya slug'dan)
                let categoryId = urlCategory || document.getElementById('filterCategory').value;
                if (urlSector && !categoryId) {
                    // Sector slug'ƒ±nƒ± kategori adƒ±na √ßevir
                    const sectorMap = {
                        'yeme-icme': 'Yeme & ƒ∞√ßme',
                        'magaza': 'Maƒüaza & Perakende',
                        'gida': 'Gƒ±da Perakendesi',
                        'hizmet': 'Hizmet',
                        'uretim': '√úretim & At√∂lye',
                        'otomotiv': 'Otomotiv',
                        'eglence': 'Eƒülence & Hobi',
                        'e-ticaret': 'E-Ticaret',
                        'diger': 'Diƒüer'
                    };
                    const sectorName = sectorMap[urlSector];
                    if (sectorName) {
                        const { data: catData } = await supabase
                            .from('categories')
                            .select('id')
                            .ilike('name', `%${sectorName.split(' ')[0]}%`)
                            .is('parent_id', null)
                            .single();
                        if (catData) {
                            categoryId = catData.id;
                            document.getElementById('filterCategory').value = categoryId;
                        }
                    }
                }
                
                // Fiyat aralƒ±ƒüƒ±nƒ± URL'den veya sidebar'dan al
                const minPrice = urlMin || document.getElementById('minPrice').value;
                const maxPrice = urlMax || document.getElementById('maxPrice').value;
                
                if (urlMin) document.getElementById('minPrice').value = urlMin;
                if (urlMax) document.getElementById('maxPrice').value = urlMax;

                let query = supabase
                    .from('listings')
                    .select(`
                        id, title, slug, price, monthly_rent, created_at, area_sqm, city, district,
                        category:categories!category_id(name, icon),
                        images:listing_images(image_url, is_primary)
                    `)
                    .eq('status', 'active');

                // Filtreleri uygula
                if (categoryId) query = query.eq('category_id', categoryId);
                if (cityName) query = query.eq('city', cityName);
                if (minPrice) query = query.gte('price', parseInt(minPrice));
                if (maxPrice) query = query.lte('price', parseInt(maxPrice));

                // Sort
                if (currentSort === 'date_desc') query = query.order('created_at', { ascending: false });
                else if (currentSort === 'date_asc') query = query.order('created_at', { ascending: true });
                else if (currentSort === 'price_desc') query = query.order('price', { ascending: false });
                else if (currentSort === 'price_asc') query = query.order('price', { ascending: true });

                const { data, error, count } = await query.limit(50);

                console.log('üìä Query sonucu:', { data, error, count });

                if (error) throw error;

                currentListings = data || [];
                console.log('‚úÖ currentListings set edildi:', currentListings.length);
                
                // Filtre bilgisini g√∂ster
                let filterInfo = '';
                if (urlCity) filterInfo += ` - ${urlCity.charAt(0).toUpperCase() + urlCity.slice(1)}`;
                if (urlSector) {
                    const sectorNames = {
                        'yeme-icme': 'Yeme & ƒ∞√ßme',
                        'magaza': 'Maƒüaza & Perakende',
                        'gida': 'Gƒ±da Perakendesi',
                        'hizmet': 'Hizmet',
                        'uretim': '√úretim & At√∂lye',
                        'otomotiv': 'Otomotiv',
                        'eglence': 'Eƒülence & Hobi',
                        'e-ticaret': 'E-Ticaret',
                        'diger': 'Diƒüer'
                    };
                    filterInfo += ` - ${sectorNames[urlSector] || urlSector}`;
                }
                if (urlMin || urlMax) {
                    const minStr = urlMin ? `‚Ç∫${parseInt(urlMin).toLocaleString('tr-TR')}` : '‚Ç∫0';
                    const maxStr = urlMax ? `‚Ç∫${parseInt(urlMax).toLocaleString('tr-TR')}` : '+';
                    filterInfo += ` - ${minStr} - ${maxStr}`;
                }
                
                document.getElementById('listingsCount').textContent = `${currentListings.length} sonu√ß g√∂steriliyor${filterInfo}`;
                console.log('‚úÖ listingsCount g√ºncellendi');

                if (currentListings.length === 0) {
                    console.log('‚ö†Ô∏è ƒ∞lan yok, empty state g√∂steriliyor');
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üîç</div>
                            <h3>ƒ∞lan bulunamadƒ±</h3>
                            <p>Farklƒ± filtreler deneyebilirsiniz</p>
                        </div>
                    `;
                    return;
                }

                console.log('‚úÖ ƒ∞lanlar render ediliyor:', currentListings.length);
                const listingItems = currentListings.map((listing, index) => {
                    try {
                        return createListingItem(listing);
                    } catch (e) {
                        console.error(`‚ùå Listing ${index} render hatasƒ±:`, e, listing);
                        return '';
                    }
                }).join('');
                
                container.innerHTML = listingItems;
                console.log('‚úÖ ƒ∞lanlar ba≈üarƒ±yla render edildi');

            } catch (e) {
                console.error('Load listings error:', e);
                document.getElementById('listingsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <h3>Hata olu≈ütu</h3>
                        <p>${e.message}</p>
                    </div>
                `;
            }
        }

        // Create listing item
        function createListingItem(listing) {
            const img = listing.images?.find(i => i.is_primary) || listing.images?.[0];
            const imgUrl = img?.image_url || '';
            const location = listing.district && listing.city ?
                `${listing.district} / ${listing.city}` : listing.city || '-';
            const category = listing.category?.name || '';

            return `
                <a href="listing-detail.html?slug=${listing.slug}" class="listing-item">
                    <div class="listing-item-image" ${imgUrl ? `style="background-image: url('${imgUrl}')"` : ''}>
                        ${!imgUrl ? '<span class="no-img">üè™</span>' : ''}
                        <button class="favorite-btn" onclick="event.preventDefault(); toggleFavorite('${listing.id}')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="listing-item-content">
                        <h3 class="listing-item-title">${listing.title}</h3>
                        <p class="listing-item-location">${location}</p>
                        <div class="listing-item-meta">
                            <span class="listing-item-category">${category}</span>
                            ${listing.area_sqm ? `<span class="listing-item-area">${listing.area_sqm} m¬≤</span>` : ''}
                        </div>
                    </div>
                    <div class="listing-item-price">
                        ${listing.monthly_rent ? `<span class="rent">Kira: ‚Ç∫${listing.monthly_rent.toLocaleString('tr-TR')}</span>` : ''}
                        <span class="price">‚Ç∫${listing.price?.toLocaleString('tr-TR') || '0'}</span>
                    </div>
                </a>
            `;
        }

        // Toggle sidebar
        function toggleSidebar() {
            document.getElementById('filterSidebar').classList.toggle('active');
        }

        // Switch sidebar tab
        function switchSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}Panel`).classList.add('active');
        }

        // Toggle accordion
        function toggleAccordion(btn) {
            btn.classList.toggle('active');
            btn.nextElementSibling.classList.toggle('active');
        }

        // Apply filters
        function applyFilters() {
            loadListings();
        }

        // Sort listings
        function sortListings(sort) {
            currentSort = sort;
            document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            loadListings();
        }

        // Search listings
        function searchListings() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.listing-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Set view
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
            document.getElementById('listingsContainer').className = `listings-container ${view}-view`;
        }

        // Toggle favorite
        function toggleFavorite(id) {
            // Implement favorite functionality
            console.log('Toggle favorite:', id);
        }
    </script>
</body>
</html>
