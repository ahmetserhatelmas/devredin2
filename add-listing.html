<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Ä°lan OluÅŸtur - DevredinPlatform</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="add-listing.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Leaflet CSS & JS (OpenStreetMap - Ãœcretsiz, API Key gerektirmez) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo">
                    <a href="index.html">devredin<span>platform</span></a>
                </div>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="listings.html" class="nav-link">Ä°ÅŸletme Devral</a></li>
                    <li><a href="create-listing.html" class="nav-link active">Ä°ÅŸletmeni Devret</a></li>
                    <li><a href="franchise.html" class="nav-link">Franchise</a></li>
                    <li><a href="#" class="nav-link">Blog</a></li>
                </ul>
                <div class="nav-buttons">
                    <div id="navLoading" class="nav-loading">
                        <div class="nav-skeleton"></div>
                        <div class="nav-skeleton"></div>
                    </div>
                    <div id="loggedOutButtons" style="display: none; gap: 1rem;">
                        <a href="login.html" class="btn btn-outline">GiriÅŸ Yap</a>
                        <a href="create-listing.html" class="btn btn-primary">Ä°lan OluÅŸtur</a>
                    </div>
                    <div id="loggedInButtons" style="display: none; align-items: center; gap: 1rem;">
                        <a href="profile.html" class="btn btn-profile" id="userName">ğŸ‘¤ Profilim</a>
                        <a href="create-listing.html" class="btn btn-primary">Ä°lan OluÅŸtur</a>
                        <button onclick="handleLogout()" class="btn btn-outline">Ã‡Ä±kÄ±ÅŸ</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Add Listing Section -->
    <section class="add-listing-section">
        <div class="container">
            <!-- Breadcrumb -->
            <div class="breadcrumb-nav">
                <a href="index.html">Ana Sayfa</a> - <span>Yeni Ä°lan BaÅŸlat</span>
            </div>

            <!-- Header with Steps -->
            <div class="form-header-new">
                <h1>Yeni Ä°lan OluÅŸtur</h1>
                <div class="steps-indicator">
                    <button class="step-btn active" data-step="1" onclick="goToStep(1)">
                        <span class="step-icon">âœ“</span>
                        Genel Ä°lan Ã–zellikleri
                    </button>
                    <button class="step-btn" data-step="2" onclick="goToStep(2)">
                        <span class="step-icon">âœ—</span>
                        Ä°ÅŸletme DetaylarÄ±
                    </button>
                    <button class="step-btn" data-step="3" onclick="goToStep(3)">
                        <span class="step-icon">âœ—</span>
                        Ä°lan YayÄ±n DetaylarÄ±
                    </button>
                </div>
            </div>

            <!-- Multi-Step Form -->
            <form id="addListingForm" class="multi-step-form">
                
                <!-- STEP 1: Genel Ä°lan Ã–zellikleri -->
                <div class="form-step active" id="step1">
                    <div class="step-content">
                        <div class="section-title">
                            <h2>Genel Ä°lan Ã–zellikleri</h2>
                        </div>

                        <div class="form-grid">
                            <!-- Ä°lan BaÅŸlÄ±ÄŸÄ± -->
                            <div class="form-group full-width">
                                <label>Ä°lan BaÅŸlÄ±ÄŸÄ± <span class="required">* zorunlu</span></label>
                                <input type="text" name="title" placeholder="Ä°lan BaÅŸlÄ±ÄŸÄ±" required>
                            </div>

                            <!-- Kategori & SektÃ¶r -->
                            <div class="form-group">
                                <label>Kategori <span class="required">* zorunlu</span></label>
                                <select name="category" id="categorySelect" required onchange="loadSubcategoriesForForm()">
                                    <option value="">SeÃ§in</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>SektÃ¶r <span class="required">* zorunlu</span></label>
                                <select name="subcategory" id="subcategorySelect" required disabled>
                                    <option value="">Ã–nce kategori seÃ§in</option>
                                </select>
                            </div>

                            <!-- KuruluÅŸ YÄ±lÄ± & Metrekare -->
                            <div class="form-group">
                                <label>KuruluÅŸ YÄ±lÄ±</label>
                                <input type="number" name="establishment_year" placeholder="1900" min="1900" max="2025">
                            </div>

                            <div class="form-group">
                                <label>Metrekare <span class="required">* zorunlu</span></label>
                                <input type="number" name="area" placeholder="0" required>
                            </div>

                            <!-- Fiyat -->
                            <div class="form-group">
                                <label>Fiyat <span class="required">* zorunlu</span></label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="price" placeholder="0" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>AylÄ±k Kira</label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="rent" placeholder="0">
                                </div>
                            </div>

                            <!-- Konum Section with Map -->
                            <div class="form-group full-width location-section">
                                <div class="location-grid">
                                    <div class="location-inputs">
                                        <div class="form-group">
                                            <label>Konum <span class="required">* zorunlu</span></label>
                                            <div class="autocomplete-wrapper">
                                                <input type="text" id="addressAutocomplete" name="address_search" placeholder="Adres aramaya baÅŸlayÄ±n..." autocomplete="off">
                                                <span class="search-icon">ğŸ”</span>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Tam Adres</label>
                                            <input type="text" id="fullAddress" name="address" placeholder="SeÃ§ilen adres burada gÃ¶rÃ¼necek" readonly>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Ä°l</label>
                                            <input type="text" id="cityInput" name="city_name" placeholder="Ä°l" readonly>
                                            <input type="hidden" id="citySelect" name="city">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Ä°lÃ§e</label>
                                            <input type="text" id="districtInput" name="district_name" placeholder="Ä°lÃ§e" readonly>
                                            <input type="hidden" id="districtSelect" name="district">
                                        </div>
                                        
                                        <!-- Hidden fields for coordinates -->
                                        <input type="hidden" id="latitude" name="latitude">
                                        <input type="hidden" id="longitude" name="longitude">
                                    </div>
                                    
                                    <div class="map-container">
                                        <div id="locationMap"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ä°lan AÃ§Ä±klamasÄ± -->
                            <div class="form-group full-width">
                                <label>Ä°lan AÃ§Ä±klamasÄ± <span class="required">* zorunlu</span></label>
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" class="toolbar-btn" onclick="formatText('bold')">KalÄ±n</button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('italic')">Ä°talik</button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('h2')">BÃ¼yÃ¼k BaÅŸlÄ±k</button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('h3')">Orta BaÅŸlÄ±k</button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('h4')">KÃ¼Ã§Ã¼k BaÅŸlÄ±k</button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('ul')">Listeleme</button>
                                    </div>
                                    <textarea name="description" id="descriptionEditor" rows="8" placeholder="AÃ§Ä±klamayÄ± buraya yazÄ±n..." required></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <div></div>
                        <button type="button" class="btn btn-next" onclick="nextStep()">Sonraki AdÄ±m</button>
                    </div>
                </div>

                <!-- STEP 2: Ä°ÅŸletme DetaylarÄ± -->
                <div class="form-step" id="step2">
                    <div class="step-content">
                        <div class="section-title">
                            <h2>Ä°ÅŸletme DetaylarÄ±</h2>
                        </div>

                        <div class="form-grid">
                            <!-- Ciro, Ã‡alÄ±ÅŸan, Net KÃ¢r -->
                            <div class="form-group">
                                <label>Ciro (AylÄ±k) <span class="info-icon" title="AylÄ±k ortalama ciro">â„¹</span></label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="monthly_revenue" placeholder="0">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Ã‡alÄ±ÅŸan SayÄ±sÄ± <span class="info-icon" title="Mevcut Ã§alÄ±ÅŸan sayÄ±sÄ±">â„¹</span></label>
                                <input type="number" name="employees" placeholder="0">
                            </div>

                            <div class="form-group">
                                <label>Net KÃ¢r (AylÄ±k) <span class="info-icon" title="AylÄ±k net kÃ¢r">â„¹</span></label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="monthly_profit" placeholder="0">
                                </div>
                            </div>

                            <!-- SatÄ±ÅŸ TÃ¼rÃ¼ -->
                            <div class="form-group full-width">
                                <label>SatÄ±ÅŸ TÃ¼rÃ¼ <span class="required">* zorunlu</span></label>
                                <select name="sale_type" required>
                                    <option value="devren_kiralik">Devren KiralÄ±k</option>
                                    <option value="devren_satilik">Devren SatÄ±lÄ±k</option>
                                    <option value="ortak_araniyor">Ortak AranÄ±yor</option>
                                </select>
                                <p class="field-hint"><strong>Devren KiralÄ±k;</strong> kiracÄ±nÄ±n dÃ¼kkÃ¢ndaki eÅŸyalarla birlikte iÅŸyerini baÅŸka birine devretmesidir. MÃ¼lk sahibinde bir deÄŸiÅŸiklik olmaz, <strong>sadece kiracÄ± deÄŸiÅŸir.</strong></p>
                            </div>

                            <!-- Kira & Kontrat BitiÅŸ -->
                            <div class="form-group">
                                <label>Kontrat BitiÅŸ Tarihi</label>
                                <input type="date" name="lease_end_date">
                            </div>

                            <div class="form-group">
                                <label>EÄŸitim, SatÄ±ÅŸ SonrasÄ± Destek <span class="required">* zorunlu</span></label>
                                <select name="training_support" required>
                                    <option value="">SeÃ§in</option>
                                    <option value="evet">Evet, saÄŸlanacak</option>
                                    <option value="hayir">HayÄ±r</option>
                                    <option value="anlasmaya_bagli">AnlaÅŸmaya baÄŸlÄ±</option>
                                </select>
                            </div>

                            <!-- DeÄŸerler -->
                            <div class="form-group">
                                <label>Duran VarlÄ±klar <span class="info-icon" title="Makine, ekipman deÄŸeri">â„¹</span></label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="equipment_value" placeholder="0">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Envanter DeÄŸeri <span class="info-icon" title="Stok deÄŸeri">â„¹</span></label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="inventory_value" placeholder="0">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Mobilya / DemirbaÅŸ DeÄŸeri <span class="info-icon" title="Mobilya ve demirbaÅŸ deÄŸeri">â„¹</span></label>
                                <div class="input-with-prefix">
                                    <span class="prefix">â‚º</span>
                                    <input type="number" name="furniture_value" placeholder="0">
                                </div>
                            </div>

                            <!-- SatÄ±ÅŸ Sebebi & Franchise -->
                            <div class="form-group">
                                <label>SatÄ±ÅŸ Sebebi <span class="required">* zorunlu</span></label>
                                <select name="reason" required>
                                    <option value="">SeÃ§in</option>
                                    <option value="emeklilik">Emeklilik</option>
                                    <option value="saglik">SaÄŸlÄ±k SorunlarÄ±</option>
                                    <option value="tasinma">Åehir DeÄŸiÅŸikliÄŸi</option>
                                    <option value="yeni_is">Yeni Ä°ÅŸ FÄ±rsatÄ±</option>
                                    <option value="maddi">Maddi Nedenler</option>
                                    <option value="aile">Aile Sebepleri</option>
                                    <option value="diger">DiÄŸer</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Franchise mÄ±? <span class="required">* zorunlu</span></label>
                                <select name="is_franchise" required>
                                    <option value="">SeÃ§in</option>
                                    <option value="yes">Evet</option>
                                    <option value="no">HayÄ±r</option>
                                </select>
                            </div>

                            <!-- Sosyal Medya -->
                            <div class="form-group">
                                <label>Instagram BaÄŸlantÄ±sÄ±</label>
                                <input type="url" name="instagram" placeholder="https://instagram.com/...">
                            </div>

                            <div class="form-group">
                                <label>Facebook BaÄŸlantÄ±sÄ±</label>
                                <input type="url" name="facebook" placeholder="https://facebook.com/...">
                            </div>

                            <div class="form-group">
                                <label>Website BaÄŸlantÄ±sÄ±</label>
                                <input type="url" name="website" placeholder="https://website.com">
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="btn btn-prev" onclick="prevStep()">Ã–nceki AdÄ±m</button>
                        <button type="button" class="btn btn-next" onclick="nextStep()">Sonraki AdÄ±m</button>
                    </div>
                </div>

                <!-- STEP 3: Ä°lan YayÄ±n DetaylarÄ± -->
                <div class="form-step" id="step3">
                    <div class="step-content">
                        <div class="section-title">
                            <h2>Ä°lan YayÄ±n DetaylarÄ±</h2>
                        </div>

                        <div class="form-grid">
                            <!-- Kapak Resmi -->
                            <div class="form-group">
                                <label>Kapak Resmi <span class="info-icon" title="Ana gÃ¶rsel">â„¹</span> <span class="required">* zorunlu</span></label>
                                <div class="file-upload-box">
                                    <input type="file" name="cover_image" id="coverImage" accept="image/*" required onchange="previewCoverImage(this)">
                                    <label for="coverImage" class="file-label">
                                        <span>Dosya SeÃ§</span>
                                        <span id="coverFileName">Dosya seÃ§ilmedi</span>
                                    </label>
                                </div>
                                <div id="coverPreview" class="image-preview"></div>
                            </div>

                            <!-- Ä°lan TanÄ±tÄ±m Belgesi -->
                            <div class="form-group">
                                <label>Ä°lan TanÄ±tÄ±m Belgesi <span class="info-icon" title="PDF veya belge">â„¹</span></label>
                                <div class="file-upload-box">
                                    <input type="file" name="document" id="documentFile" accept=".pdf,.doc,.docx">
                                    <label for="documentFile" class="file-label">
                                        <span>Dosya SeÃ§</span>
                                        <span id="docFileName">Dosya seÃ§ilmedi</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Ä°lan GÃ¶rselleri -->
                            <div class="form-group full-width">
                                <label>Ä°lan GÃ¶rselleri</label>
                                <div class="multi-upload-area" id="imageDropZone">
                                    <div class="upload-icon">â¬†ï¸</div>
                                    <p>DosyalarÄ± sÃ¼rÃ¼kleyip bÄ±rakÄ±n veya tÄ±klayarak seÃ§in</p>
                                    <p class="upload-hint">Maksimum 20 dosya, her biri en fazla 4MB</p>
                                    <p class="upload-hint">Kabul edilen dosya tipleri: image/*</p>
                                    <input type="file" name="images" id="imageUpload" accept="image/*" multiple style="display: none;">
                                </div>
                                <div id="imagePreviewGrid" class="image-preview-grid"></div>
                            </div>

                            <!-- Ä°letiÅŸim Bilgileri -->
                            <div class="form-group full-width">
                                <div class="section-divider"></div>
                                <h3 style="margin-bottom: 1rem;">Ä°letiÅŸim Bilgileri</h3>
                            </div>

                            <div class="form-group">
                                <label>Ä°letiÅŸim AdÄ± <span class="required">* zorunlu</span></label>
                                <input type="text" name="contact_name" placeholder="Ad Soyad" required>
                            </div>

                            <div class="form-group">
                                <label>Telefon <span class="required">* zorunlu</span></label>
                                <input type="tel" name="phone" placeholder="0532 123 45 67" required>
                            </div>

                            <div class="form-group">
                                <label>E-posta <span class="required">* zorunlu</span></label>
                                <input type="email" name="email" placeholder="ornek@email.com" required>
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="btn btn-prev" onclick="prevStep()">Ã–nceki AdÄ±m</button>
                        <button type="submit" class="btn btn-submit">Ä°lanÄ± YayÄ±nla</button>
                    </div>
                </div>

            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>devredinplatform</h3>
                    <p>TÃ¼rkiye'nin en bÃ¼yÃ¼k iÅŸletme devir platformu</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Copyright Â© 2025 Devredin Bilgi Teknolojileri. TÃ¼m HaklarÄ± SaklÄ±dÄ±r.</p>
            </div>
        </div>
    </footer>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="backend/api.js"></script>
    <script src="script.js"></script>
    
    <script>
        let currentStep = 1;
        const totalSteps = 3;
        let map;
        let marker;
        let searchTimeout;
        
        // Initialize Map when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Map will be initialized after user auth check
            setTimeout(initLeafletMap, 500);
        });
        
        // Leaflet Map Initialization (OpenStreetMap - Free, no API key needed)
        function initLeafletMap() {
            console.log('ğŸ—ºï¸ Leaflet Harita baÅŸlatÄ±lÄ±yor...');
            
            // Default location: Istanbul
            const defaultLocation = [41.0082, 28.9784];
            
            // Initialize map
            map = L.map('locationMap', {
                zoomControl: true
            }).setView(defaultLocation, 11);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(map);
            
            // Create draggable marker
            marker = L.marker(defaultLocation, {
                draggable: true
            });
            
            // Marker drag event
            marker.on('dragend', function(e) {
                const pos = marker.getLatLng();
                reverseGeocode(pos.lat, pos.lng);
            });
            
            // Map click event
            map.on('click', function(e) {
                const { lat, lng } = e.latlng;
                marker.setLatLng([lat, lng]).addTo(map);
                reverseGeocode(lat, lng);
            });
            
            // Setup autocomplete
            setupAddressAutocomplete();
            
            console.log('âœ… Harita hazÄ±r');
        }
        
        // Address Autocomplete Setup (using Nominatim - Free)
        function setupAddressAutocomplete() {
            const input = document.getElementById('addressAutocomplete');
            const suggestionsContainer = createSuggestionsContainer();
            
            input.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) clearTimeout(searchTimeout);
                
                // Hide suggestions if query is too short
                if (query.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                // Debounce search
                searchTimeout = setTimeout(() => {
                    searchAddress(query, suggestionsContainer);
                }, 300);
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }
        
        // Create suggestions container
        function createSuggestionsContainer() {
            const input = document.getElementById('addressAutocomplete');
            const wrapper = input.closest('.autocomplete-wrapper');
            
            let container = document.getElementById('addressSuggestions');
            if (!container) {
                container = document.createElement('div');
                container.id = 'addressSuggestions';
                container.className = 'address-suggestions';
                wrapper.appendChild(container);
            }
            
            return container;
        }
        
        // Search address using Nominatim API (Free, no API key)
        async function searchAddress(query, container) {
            try {
                // Add "TÃ¼rkiye" to improve results for Turkey
                const searchQuery = query.includes('TÃ¼rkiye') ? query : `${query}, TÃ¼rkiye`;
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=tr&limit=5&addressdetails=1&accept-language=tr`,
                    {
                        headers: {
                            'Accept': 'application/json'
                        }
                    }
                );
                
                const results = await response.json();
                
                if (results.length === 0) {
                    container.innerHTML = '<div class="no-results">SonuÃ§ bulunamadÄ±</div>';
                    container.style.display = 'block';
                    return;
                }
                
                // Render suggestions
                container.innerHTML = results.map(place => `
                    <div class="suggestion-item" data-lat="${place.lat}" data-lon="${place.lon}" data-address='${JSON.stringify(place.address)}' data-display="${place.display_name}">
                        <span class="suggestion-icon">ğŸ“</span>
                        <div class="suggestion-text">
                            <span class="suggestion-main">${place.display_name.split(',')[0]}</span>
                            <span class="suggestion-secondary">${place.display_name.split(',').slice(1, 3).join(',')}</span>
                        </div>
                    </div>
                `).join('');
                
                container.style.display = 'block';
                
                // Add click handlers
                container.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        selectAddress(this);
                        container.style.display = 'none';
                    });
                });
                
            } catch (error) {
                console.error('âŒ Adres arama hatasÄ±:', error);
                container.innerHTML = '<div class="no-results">Arama yapÄ±lÄ±rken hata oluÅŸtu</div>';
                container.style.display = 'block';
            }
        }
        
        // Select address from suggestions
        function selectAddress(item) {
            const lat = parseFloat(item.dataset.lat);
            const lon = parseFloat(item.dataset.lon);
            const displayName = item.dataset.display;
            const address = JSON.parse(item.dataset.address);
            
            // Update input
            document.getElementById('addressAutocomplete').value = displayName;
            
            // Update map
            map.setView([lat, lon], 17);
            marker.setLatLng([lat, lon]).addTo(map);
            
            // Fill form fields
            fillAddressFields(displayName, address, lat, lon);
            
            console.log('âœ… Konum seÃ§ildi:', displayName);
        }
        
        // Fill address fields from Nominatim data
        function fillAddressFields(displayName, address, lat, lon) {
            // Set full address
            document.getElementById('fullAddress').value = displayName || '';
            
            // Set coordinates
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            
            // Parse address components from Nominatim
            const city = address.province || address.state || address.city || '';
            const district = address.county || address.town || address.suburb || address.city_district || '';
            
            // Fill city and district fields
            document.getElementById('cityInput').value = city;
            document.getElementById('districtInput').value = district;
            
            // Match with database
            matchCityWithDatabase(city);
            matchDistrictWithDatabase(district);
            
            console.log('ğŸ“ Adres bilgileri dolduruldu:', { city, district });
        }
        
        // Reverse geocode from coordinates (when clicking on map or dragging marker)
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1&accept-language=tr`
                );
                
                const result = await response.json();
                
                if (result && result.display_name) {
                    document.getElementById('addressAutocomplete').value = result.display_name;
                    fillAddressFields(result.display_name, result.address, lat, lon);
                    console.log('ğŸ”„ Ters geocoding tamamlandÄ±');
                }
            } catch (error) {
                console.error('âŒ Ters geocoding hatasÄ±:', error);
            }
        }
        
        // Match city with database
        async function matchCityWithDatabase(cityName) {
            if (!cityName) return;
            
            try {
                // Clean city name
                cityName = cityName.replace(' Ä°li', '').replace(' Ili', '').replace(' Province', '').trim();
                
                const { data, error } = await supabase
                    .from('cities')
                    .select('id, name')
                    .ilike('name', `%${cityName}%`)
                    .limit(1);
                
                if (data && data.length > 0) {
                    document.getElementById('citySelect').value = data[0].id;
                    console.log('âœ… Åehir eÅŸleÅŸtirildi:', data[0].name);
                }
            } catch (error) {
                console.error('âŒ Åehir eÅŸleÅŸtirme hatasÄ±:', error);
            }
        }
        
        // Match district with database
        async function matchDistrictWithDatabase(districtName) {
            if (!districtName) return;
            
            try {
                const cityId = document.getElementById('citySelect').value;
                
                if (!cityId) {
                    setTimeout(() => matchDistrictWithDatabase(districtName), 500);
                    return;
                }
                
                const { data, error } = await supabase
                    .from('districts')
                    .select('id, name')
                    .eq('city_id', parseInt(cityId))
                    .ilike('name', `%${districtName}%`)
                    .limit(1);
                
                if (data && data.length > 0) {
                    document.getElementById('districtSelect').value = data[0].id;
                    console.log('âœ… Ä°lÃ§e eÅŸleÅŸtirildi:', data[0].name);
                }
            } catch (error) {
                console.error('âŒ Ä°lÃ§e eÅŸleÅŸtirme hatasÄ±:', error);
            }
        }
        
        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Ä°lan verme sayfasÄ± yÃ¼klendi')
            
            // Navbar is managed by api.js automatically
            
            // Check if user is logged in using cached data first
            const cachedUser = getCachedUser()
            const cachedProfile = getCachedProfile()
            
            if (!cachedUser) {
                // Verify with API
                const user = await getCurrentUser()
                if (!user) {
                    alert('âš ï¸ Ä°lan vermek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z!')
                    window.location.href = 'login.html'
                    return
                }
            }
            
            // Fill user info from cache first, then verify
            if (cachedProfile) {
                const contactName = document.querySelector('input[name="contact_name"]')
                const phone = document.querySelector('input[name="phone"]')
                if (contactName) contactName.value = cachedProfile.full_name || ''
                if (phone) phone.value = cachedProfile.phone || ''
            }
            if (cachedUser) {
                const email = document.querySelector('input[name="email"]')
                if (email) email.value = cachedUser.email || ''
            }
            
            // Verify and update from API
            const user = await getCurrentUser()
            if (user) {
                const profile = await fetchUserProfile(user.id)
                if (profile) {
                    const contactName = document.querySelector('input[name="contact_name"]')
                    const phone = document.querySelector('input[name="phone"]')
                    if (contactName) contactName.value = profile.full_name || ''
                    if (phone) phone.value = profile.phone || ''
                }
                const email = document.querySelector('input[name="email"]')
                if (email) email.value = user.email || ''
            }
            
            await loadCategoriesForForm()
            await loadCitiesForForm()
            setupImageUpload()
        })
        
        // Ana kategorileri yÃ¼kle
        async function loadCategoriesForForm() {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('id, name, icon')
                    .is('parent_id', null)
                    .order('name')
                
                if (error) throw error
                
                const categorySelect = document.getElementById('categorySelect')
                categorySelect.innerHTML = '<option value="">SeÃ§in</option>' + 
                    data.map(cat => `<option value="${cat.id}">${cat.icon || ''} ${cat.name}</option>`).join('')
                
                console.log('âœ… Kategoriler yÃ¼klendi')
            } catch (error) {
                console.error('âŒ Kategori yÃ¼kleme hatasÄ±:', error)
            }
        }
        
        // Alt kategorileri (sektÃ¶rleri) yÃ¼kle
        async function loadSubcategoriesForForm() {
            const categoryId = document.getElementById('categorySelect').value
            const subcategorySelect = document.getElementById('subcategorySelect')
            
            if (!categoryId) {
                subcategorySelect.innerHTML = '<option value="">Ã–nce kategori seÃ§in</option>'
                subcategorySelect.disabled = true
                return
            }
            
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('id, name, icon')
                    .eq('parent_id', categoryId)
                    .order('name')
                
                if (error) throw error
                
                if (data.length === 0) {
                    subcategorySelect.innerHTML = '<option value="">Bu kategoride sektÃ¶r yok</option>'
                    subcategorySelect.disabled = true
                    return
                }
                
                subcategorySelect.disabled = false
                subcategorySelect.innerHTML = '<option value="">SeÃ§in</option>' + 
                    data.map(sub => `<option value="${sub.id}">${sub.icon || ''} ${sub.name}</option>`).join('')
                
                console.log('âœ… SektÃ¶rler yÃ¼klendi')
            } catch (error) {
                console.error('âŒ SektÃ¶r yÃ¼kleme hatasÄ±:', error)
            }
        }
        
        // Åehirleri yÃ¼kle (Google Maps Autocomplete ile otomatik doldurulacak)
        async function loadCitiesForForm() {
            console.log('ğŸ“ Åehirler Google Maps Autocomplete ile otomatik doldurulacak')
        }
        
        // Ä°lÃ§eleri yÃ¼kle (Google Maps Autocomplete ile otomatik doldurulacak)
        async function loadDistrictsForStep() {
            console.log('ğŸ“ Ä°lÃ§eler Google Maps Autocomplete ile otomatik doldurulacak')
        }
        
        // Step Navigation
        function goToStep(step) {
            if (step < 1 || step > totalSteps) return
            
            // Validate current step before moving forward
            if (step > currentStep && !validateStep(currentStep)) {
                return
            }
            
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'))
            document.getElementById(`step${step}`).classList.add('active')
            
            updateStepIndicators(step)
            currentStep = step
            
            window.scrollTo({ top: 0, behavior: 'smooth' })
        }
        
        function nextStep() {
            if (currentStep < totalSteps) {
                goToStep(currentStep + 1)
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1)
            }
        }
        
        function updateStepIndicators(activeStep) {
            document.querySelectorAll('.step-btn').forEach((btn, index) => {
                const stepNum = index + 1
                btn.classList.remove('active', 'completed')
                
                if (stepNum < activeStep) {
                    btn.classList.add('completed')
                    btn.querySelector('.step-icon').textContent = 'âœ“'
                } else if (stepNum === activeStep) {
                    btn.classList.add('active')
                    btn.querySelector('.step-icon').textContent = 'âœ“'
                } else {
                    btn.querySelector('.step-icon').textContent = 'âœ—'
                }
            })
        }
        
        function validateStep(step) {
            const stepEl = document.getElementById(`step${step}`)
            const requiredFields = stepEl.querySelectorAll('[required]')
            let isValid = true
            
            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('error')
                    isValid = false
                } else {
                    field.classList.remove('error')
                }
            })
            
            if (!isValid) {
                alert('âš ï¸ LÃ¼tfen zorunlu alanlarÄ± doldurun!')
            }
            
            return isValid
        }
        
        // Image Upload Setup
        function setupImageUpload() {
            const dropZone = document.getElementById('imageDropZone')
            const fileInput = document.getElementById('imageUpload')
            
            dropZone.addEventListener('click', () => fileInput.click())
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault()
                dropZone.classList.add('dragover')
            })
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover')
            })
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault()
                dropZone.classList.remove('dragover')
                handleFiles(e.dataTransfer.files)
            })
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files)
            })
        }
        
        let uploadedImages = []
        
        function handleFiles(files) {
            const previewGrid = document.getElementById('imagePreviewGrid')
            
            Array.from(files).forEach(file => {
                if (uploadedImages.length >= 20) {
                    alert('Maksimum 20 gÃ¶rsel yÃ¼kleyebilirsiniz!')
                    return
                }
                
                if (file.size > 4 * 1024 * 1024) {
                    alert(`${file.name} dosyasÄ± 4MB'dan bÃ¼yÃ¼k!`)
                    return
                }
                
                const reader = new FileReader()
                reader.onload = (e) => {
                    uploadedImages.push({ file, preview: e.target.result })
                    renderImagePreviews()
                }
                reader.readAsDataURL(file)
            })
        }
        
        function renderImagePreviews() {
            const previewGrid = document.getElementById('imagePreviewGrid')
            previewGrid.innerHTML = uploadedImages.map((img, index) => `
                <div class="preview-item">
                    <img src="${img.preview}" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeImage(${index})">âœ•</button>
                </div>
            `).join('')
        }
        
        function removeImage(index) {
            uploadedImages.splice(index, 1)
            renderImagePreviews()
        }
        
        function previewCoverImage(input) {
            const fileName = document.getElementById('coverFileName')
            const preview = document.getElementById('coverPreview')
            
            if (input.files && input.files[0]) {
                fileName.textContent = input.files[0].name
                
                const reader = new FileReader()
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Cover Preview">`
                }
                reader.readAsDataURL(input.files[0])
            }
        }
        
        function formatText(format) {
            const textarea = document.getElementById('descriptionEditor')
            const start = textarea.selectionStart
            const end = textarea.selectionEnd
            const selectedText = textarea.value.substring(start, end)
            
            let formattedText = ''
            switch(format) {
                case 'bold': formattedText = `**${selectedText}**`; break
                case 'italic': formattedText = `*${selectedText}*`; break
                case 'h2': formattedText = `\n## ${selectedText}\n`; break
                case 'h3': formattedText = `\n### ${selectedText}\n`; break
                case 'h4': formattedText = `\n#### ${selectedText}\n`; break
                case 'ul': formattedText = `\n- ${selectedText}\n`; break
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end)
        }
        
        // Form Submission
        document.getElementById('addListingForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            if (!validateStep(3)) return
            
            console.log('ğŸ“ Form gÃ¶nderiliyor...')
            
            const formData = new FormData(e.target)
            
            const listingData = {
                title: formData.get('title'),
                description: formData.get('description'),
                category_id: parseInt(formData.get('category')),
                subcategory_id: formData.get('subcategory') ? parseInt(formData.get('subcategory')) : null,
                city_id: parseInt(formData.get('city')) || null,
                district_id: parseInt(formData.get('district')) || null,
                address: formData.get('address'),
                latitude: parseFloat(formData.get('latitude')) || null,
                longitude: parseFloat(formData.get('longitude')) || null,
                area_sqm: parseInt(formData.get('area')) || null,
                establishment_year: parseInt(formData.get('establishment_year')) || null,
                employee_count: parseInt(formData.get('employees')) || null,
                is_franchise: formData.get('is_franchise') === 'yes',
                price: parseFloat(formData.get('price')),
                monthly_rent: parseFloat(formData.get('rent')) || null,
                monthly_revenue: parseFloat(formData.get('monthly_revenue')) || null,
                monthly_profit: parseFloat(formData.get('monthly_profit')) || null,
                inventory_value: parseFloat(formData.get('inventory_value')) || null,
                equipment_value: parseFloat(formData.get('equipment_value')) || null,
                lease_end_date: formData.get('lease_end_date') || null,
                transfer_reason: formData.get('reason') || null,
                contact_name: formData.get('contact_name'),
                contact_phone: formData.get('phone'),
                contact_email: formData.get('email')
            }
            
            console.log('ğŸ“Š Ä°lan verisi:', listingData)
            
            try {
                const result = await createListing(listingData)
                
                if (result.success) {
                    alert('âœ… Ä°lanÄ±nÄ±z baÅŸarÄ±yla oluÅŸturuldu! Admin onayÄ±ndan sonra yayÄ±nlanacaktÄ±r.')
                    window.location.href = 'profile.html'
                } else {
                    alert('âŒ Hata: ' + result.error)
                }
            } catch (error) {
                console.error('âŒ Form gÃ¶nderim hatasÄ±:', error)
                alert('âŒ Bir hata oluÅŸtu: ' + error.message)
            }
        })
    </script>
</body>
</html>
