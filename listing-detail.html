<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞lan Detayƒ± - Devredin</title>
    <link rel="stylesheet" href="styles.css?v=13">
    <link rel="stylesheet" href="listing-detail.css?v=5">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo">
                    <a href="index.html" class="logo-main">devredin</a>
                    <span class="logo-divider">|</span>
                    <a href="franchise.html" class="logo-sub">fr.</a>
                </div>
                
                <ul class="nav-menu">
                    <li><a href="listings.html" class="nav-link">ƒ∞≈ületme Devral</a></li>
                    <li><a href="add-listing.html" class="nav-link">ƒ∞≈ületmeni Devret</a></li>
                    <li><a href="blog.html" class="nav-link">Blog</a></li>
                </ul>
                
                <div class="nav-actions">
                    <button class="nav-icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                    
                    <button class="nav-icon-btn" onclick="window.location.href='login.html'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </button>
                    
                    <div class="lang-selector">
                        <span class="flag">üáπüá∑</span>
                        <span>TR</span>
                    </div>
                    
                    <a href="add-listing.html" class="btn btn-primary-nav">√úcretsiz ƒ∞lan Olu≈ütur</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="detail-main">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="index.html">Ana Sayfa</a>
                <span>‚Ä∫</span>
                <a href="listings.html">ƒ∞lanlar</a>
                <span>‚Ä∫</span>
                <span id="breadcrumbTitle">ƒ∞lan Detayƒ±</span>
            </nav>

            <!-- Header -->
            <div class="detail-header">
                <h1 id="listingTitle">ƒ∞lan Ba≈ülƒ±ƒüƒ±</h1>
                <div class="detail-actions">
                    <button class="action-btn" onclick="toggleFavorite()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        Favorilere Ekle
                    </button>
                    <button class="action-btn" onclick="shareListing()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        Payla≈ü
                    </button>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="detail-grid">
                <!-- Left Column -->
                <div class="detail-left">
                    <!-- Gallery -->
                    <div class="gallery">
                        <div class="gallery-main" id="galleryMain">
                            <img src="" alt="Ana g√∂rsel" id="mainImage">
                            <button class="gallery-zoom" onclick="openFullscreen()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <polyline points="9 21 3 21 3 15"></polyline>
                                    <line x1="21" y1="3" x2="14" y2="10"></line>
                                    <line x1="3" y1="21" x2="10" y2="14"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="gallery-thumbs" id="galleryThumbs">
                            <!-- Thumbnails will be loaded -->
                        </div>
                    </div>

                    <!-- Info Cards -->
                    <div class="info-section">
                        <div class="price-box">
                            <span class="price" id="listingPrice">‚Ç∫0</span>
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                <span id="listingLocation">Konum</span>
                            </div>
                            <div class="info-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                </svg>
                                <span id="listingType">Devren Kiralƒ±k</span>
                            </div>
                        </div>

                        <div class="specs-table">
                            <div class="spec-row">
                                <span class="spec-label">Kategori</span>
                                <span class="spec-value" id="specCategory">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Sekt√∂r</span>
                                <span class="spec-value" id="specSector">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Metrekare</span>
                                <span class="spec-value" id="specArea">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Kira</span>
                                <span class="spec-value" id="specRent">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Kontrat Biti≈ü Tarihi</span>
                                <span class="spec-value" id="specContract">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">√áalƒ±≈üan Sayƒ±sƒ±</span>
                                <span class="spec-value" id="specEmployees">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Ciro (Aylƒ±k)</span>
                                <span class="spec-value" id="specRevenue">-</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Net Kar (Aylƒ±k)</span>
                                <span class="spec-value" id="specProfit">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs-section">
                        <div class="tabs-header">
                            <button class="tab-btn active" onclick="switchTab('description')">A√ßƒ±klama</button>
                            <button class="tab-btn" onclick="switchTab('details')">ƒ∞lan Detaylarƒ±</button>
                            <button class="tab-btn" onclick="switchTab('location')">Konum ve Sokak G√∂r√ºn√ºm√º</button>
                        </div>

                        <div class="tab-content active" id="descriptionTab">
                            <div class="description-content" id="descriptionContent">
                                <p>ƒ∞lan a√ßƒ±klamasƒ± y√ºkleniyor...</p>
                            </div>
                        </div>

                        <div class="tab-content" id="detailsTab">
                            <div class="details-table">
                                <div class="detail-row">
                                    <span class="detail-label">ƒ∞lan Tarihi</span>
                                    <span class="detail-value" id="detailDate">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Kategori</span>
                                    <span class="detail-value" id="detailCategory">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Sekt√∂r</span>
                                    <span class="detail-value" id="detailSector">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Envanter</span>
                                    <span class="detail-value" id="detailInventory">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Demirba≈ü</span>
                                    <span class="detail-value" id="detailFixtures">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Mobilya, Demirba≈ü ve Ekipman (FF&E)</span>
                                    <span class="detail-value" id="detailFFE">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Destek ve Eƒüitim</span>
                                    <span class="detail-value" id="detailSupport">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Satƒ±≈ü Sebebi</span>
                                    <span class="detail-value" id="detailReason">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Kurulu≈ü Tarihi</span>
                                    <span class="detail-value" id="detailEstablished">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Franchise</span>
                                    <span class="detail-value" id="detailFranchise">-</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Kontrat Biti≈ü Tarihi</span>
                                    <span class="detail-value" id="detailContractEnd">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="locationTab">
                            <div class="map-container" id="mapContainer">
                                <div id="map" style="width: 100%; height: 100%; min-height: 400px;"></div>
                            </div>
                            <a href="#" class="directions-btn" id="directionsBtn" target="_blank">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                Yol Tarifi Al
                            </a>
                        </div>
                    </div>

                    <!-- Similar Listings -->
                    <div class="similar-section">
                        <h3>Benzer ƒ∞lanlar</h3>
                        <div class="similar-slider" id="similarListings">
                            <!-- Similar listings will be loaded -->
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="detail-sidebar">
                    <div class="seller-card">
                        <div class="seller-info">
                            <div class="seller-avatar" id="sellerAvatar">
                                <span id="sellerInitials">?</span>
                            </div>
                            <div class="seller-details">
                                <h4 id="sellerName">ƒ∞lan Sahibi</h4>
                            </div>
                        </div>
                        
                        <div class="seller-phone" id="sellerPhone">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            <span>Telefon bilgisi gizli</span>
                        </div>
                        
                        <div class="seller-actions">
                            <button class="btn btn-whatsapp" onclick="sendWhatsApp()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                                Mesaj G√∂nder
                            </button>
                            <button class="btn btn-call" onclick="callSeller()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                                Ara
                            </button>
                        </div>
                        
                        <button class="btn btn-offer" onclick="sendOffer()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Teklif G√∂nder
                        </button>
                    </div>

                    <div class="documents-card">
                        <h4>D√∂k√ºmanlar</h4>
                        <div class="document-item">
                            <div class="document-icon">
                                <span class="doc-logo">d.</span>
                            </div>
                            <div class="document-info">
                                <span class="document-title">Devredin ƒ∞lan Raporu</span>
                                <span class="document-desc">Otomatik olu≈üturulmu≈ü rapor</span>
                            </div>
                            <button class="document-view" onclick="viewReport()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Section -->
        <section class="contact-section">
            <div class="container">
                <div class="contact-header">
                    <span class="contact-subtitle">Aradƒ±ƒüƒ±nƒ±zƒ± bulamadƒ±nƒ±z mƒ±? Bize yazƒ±n</span>
                    <h2 class="contact-title">En kƒ±sa s√ºrede geri d√∂n√º≈ü yapacaƒüƒ±z</h2>
                </div>
                
                <div class="contact-form-wrapper">
                    <form class="contact-form" onsubmit="handleContactSubmit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ad</label>
                                <input type="text" placeholder="Adƒ±nƒ±zƒ± yazƒ±n" required>
                            </div>
                            <div class="form-group">
                                <label>Soyad</label>
                                <input type="text" placeholder="Soyadƒ±nƒ±zƒ± yazƒ±n" required>
                            </div>
                            <div class="form-group form-group-large">
                                <label>Mesaj</label>
                                <textarea placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n" rows="4" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telefon Numarasƒ±</label>
                                <div class="phone-input">
                                    <select class="country-code">
                                        <option value="+90">üáπüá∑ +90</option>
                                    </select>
                                    <input type="tel" placeholder="+90">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>E-posta Adresi</label>
                                <input type="email" placeholder="E-posta adresinizi yazƒ±n" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-submit">G√∂nder</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="index.html" class="footer-logo">d.</a>
                    <p class="footer-copyright">
                        Copyright ¬© 2025<br>
                        Devredin Bilgi Teknolojileri<br>
                        Yazƒ±lƒ±m ve Ticaret A.≈û.<br>
                        T√ºm Haklarƒ± Saklƒ±dƒ±r.
                    </p>
                </div>
                
                <div class="footer-links">
                    <h4>Devredin</h4>
                    <ul>
                        <li><a href="#">Hakkƒ±mƒ±zda</a></li>
                        <li><a href="#">Bize Ula≈üƒ±n</a></li>
                        <li><a href="#">ƒ∞≈ülem Rehberi</a></li>
                        <li><a href="#">Sƒ±k√ßa Sorulan Sorular</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                
                <div class="footer-links">
                    <h4>ƒ∞≈ületme Devral</h4>
                    <ul>
                        <li><a href="listings.html">Devren Kiralƒ±k ƒ∞lanlar</a></li>
                        <li><a href="franchise.html">Franchise Bul</a></li>
                        <li><a href="add-listing.html">ƒ∞lan Verme Kurallarƒ±</a></li>
                    </ul>
                </div>
                
                <div class="footer-links">
                    <h4>Diƒüer</h4>
                    <ul>
                        <li><a href="#">Kullanƒ±m Ko≈üullarƒ±</a></li>
                        <li><a href="#">Aydƒ±nlatma Metni</a></li>
                        <li><a href="#">KVKK</a></li>
                        <li><a href="#">Gizlilik S√∂zle≈ümesi</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="social-links">
                    <a href="#" class="social-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    </a>
                    <a href="#" class="social-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="#" class="social-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="backend/api.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC4r_aAIPvRAEGPqARc-Y9s-UstldmSqk&language=tr"></script>
    <script>
        let currentListing = null;
        let currentImages = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const listingId = urlParams.get('id');
            const listingSlug = urlParams.get('slug');
            
            if (!listingId && !listingSlug) {
                alert('ƒ∞lan bulunamadƒ±');
                window.location.href = 'listings.html';
                return;
            }
            
            await loadListing(listingId, listingSlug);
            await loadSimilarListings();
        });

        async function loadListing(id, slug) {
            try {
                let query = supabase
                    .from('listings')
                    .select(`
                        *,
                        category:categories!category_id(name, icon),
                        images:listing_images(image_url, is_primary)
                    `);
                
                // Search by ID or slug
                if (id) {
                    query = query.eq('id', id);
                } else if (slug) {
                    query = query.eq('slug', slug);
                }
                
                const { data, error } = await query.single();

                if (error) {
                    console.error('Supabase error:', error);
                    showError('ƒ∞lan y√ºklenirken hata olu≈ütu: ' + error.message);
                    return;
                }
                
                if (!data) {
                    showError('Bu ilan bulunamadƒ± veya kaldƒ±rƒ±lmƒ±≈ü olabilir.');
                    return;
                }
                
                // ƒ∞lan sahibi bilgisini ayrƒ± √ßek
                if (data.user_id) {
                    try {
                        const { data: ownerData, error: ownerError } = await supabase
                            .from('profiles')
                            .select('full_name, phone')
                            .eq('id', data.user_id)
                            .single();
                        
                        if (!ownerError && ownerData) {
                            data.owner = ownerData;
                        }
                    } catch (e) {
                        // Owner data optional, continue anyway
                    }
                }

                currentListing = data;
                currentImages = data.images || [];
                renderListing(data);
                
                // Initialize map if coordinates exist
                if (data.latitude && data.longitude) {
                    initDetailMap(data.latitude, data.longitude, data.title, data.city, data.district);
                }

            } catch (e) {
                console.error('Load error:', e);
                showError('ƒ∞lan y√ºklenirken beklenmeyen bir hata olu≈ütu.');
            }
        }
        
        function showError(message) {
            document.querySelector('.detail-grid').innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üòï</div>
                    <h2 style="font-size: 1.5rem; color: #1f2937; margin-bottom: 0.5rem;">ƒ∞lan Bulunamadƒ±</h2>
                    <p style="color: #6b7280; margin-bottom: 2rem;">${message}</p>
                    <a href="listings.html" style="display: inline-block; padding: 0.75rem 1.5rem; background: #004E89; color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">T√ºm ƒ∞lanlarƒ± G√∂r√ºnt√ºle</a>
                </div>
            `;
        }

        function renderListing(listing) {
            // Title
            document.title = `${listing.title} - Devredin`;
            document.getElementById('listingTitle').textContent = listing.title;
            document.getElementById('breadcrumbTitle').textContent = listing.title;

            // Gallery
            const mainImg = listing.images?.find(i => i.is_primary) || listing.images?.[0];
            const mainImgUrl = mainImg?.image_url || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&h=500&fit=crop';
            document.getElementById('mainImage').src = mainImgUrl;
            
            const thumbsEl = document.getElementById('galleryThumbs');
            if (listing.images && listing.images.length > 0) {
                thumbsEl.innerHTML = listing.images.map((img, idx) => `
                    <div class="thumb ${idx === 0 ? 'active' : ''}" onclick="selectImage(${idx})">
                        <img src="${img.image_url}" alt="G√∂rsel ${idx + 1}">
                    </div>
                `).join('');
            } else {
                thumbsEl.innerHTML = '<p style="color:#6b7280;font-size:0.9rem;">Bu ilan i√ßin g√∂rsel eklenmemi≈ü</p>';
            }

            // Price & Location
            document.getElementById('listingPrice').textContent = `‚Ç∫${(listing.price || 0).toLocaleString('tr-TR')}`;
            const location = listing.district && listing.city 
                ? `${listing.district} / ${listing.city}` 
                : listing.city || listing.address || '-';
            document.getElementById('listingLocation').textContent = location;

            // Specs
            document.getElementById('specCategory').textContent = listing.category?.name || '-';
            document.getElementById('specSector').textContent = '-'; // Subcategory removed
            document.getElementById('specArea').textContent = listing.area_sqm ? `${listing.area_sqm} m¬≤` : '-';
            document.getElementById('specRent').textContent = listing.monthly_rent ? `‚Ç∫${listing.monthly_rent.toLocaleString('tr-TR')}/ay` : '-';
            document.getElementById('specContract').textContent = listing.lease_end_date || '-';
            document.getElementById('specEmployees').textContent = listing.employee_count ? `${listing.employee_count} ki≈üi` : '-';
            document.getElementById('specRevenue').textContent = listing.monthly_revenue ? `‚Ç∫${listing.monthly_revenue.toLocaleString('tr-TR')}` : '-';
            document.getElementById('specProfit').textContent = listing.monthly_profit ? `‚Ç∫${listing.monthly_profit.toLocaleString('tr-TR')}` : '-';

            // Description
            const desc = listing.description || 'A√ßƒ±klama bulunmuyor.';
            document.getElementById('descriptionContent').innerHTML = desc.split('\n').map(p => p ? `<p>${p}</p>` : '').join('');

            // Details Tab
            document.getElementById('detailDate').textContent = new Date(listing.created_at).toLocaleDateString('tr-TR');
            document.getElementById('detailCategory').textContent = listing.category?.name || '-';
            document.getElementById('detailSector').textContent = listing.sector || '-';
            document.getElementById('detailInventory').textContent = listing.inventory_value ? `‚Ç∫${listing.inventory_value.toLocaleString('tr-TR')}` : '-';
            document.getElementById('detailFixtures').textContent = listing.equipment_value ? `‚Ç∫${listing.equipment_value.toLocaleString('tr-TR')}` : '-';
            document.getElementById('detailFFE').textContent = '-'; // FFE field doesn't exist in DB
            document.getElementById('detailSupport').textContent = listing.includes_training ? 'Evet' : 'Hayƒ±r';
            document.getElementById('detailReason').textContent = listing.transfer_reason || '-';
            document.getElementById('detailEstablished').textContent = listing.establishment_year || '-';
            document.getElementById('detailFranchise').textContent = listing.is_franchise ? 'Evet' : 'Hayƒ±r';
            document.getElementById('detailContractEnd').textContent = listing.lease_end_date || '-';

            // Location Tab
            if (listing.latitude && listing.longitude) {
                document.getElementById('mapContainer').innerHTML = `
                    <iframe 
                        src="https://maps.google.com/maps?q=${listing.latitude},${listing.longitude}&z=15&output=embed"
                        width="100%" 
                        height="400" 
                        style="border:0;border-radius:12px;" 
                        allowfullscreen="" 
                        loading="lazy">
                    </iframe>
                `;
                document.getElementById('directionsBtn').href = `https://www.google.com/maps/dir/?api=1&destination=${listing.latitude},${listing.longitude}`;
            }

            // Seller Info
            const owner = listing.owner;
            if (owner) {
                document.getElementById('sellerName').textContent = owner.full_name || 'ƒ∞lan Sahibi';
                const initials = (owner.full_name || 'ƒ∞S').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                document.getElementById('sellerInitials').textContent = initials;
                if (owner.phone) {
                    document.getElementById('sellerPhone').innerHTML = `
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <span>${owner.phone}</span>
                    `;
                }
            }
        }

        function selectImage(index) {
            if (currentImages[index]) {
                document.getElementById('mainImage').src = currentImages[index].image_url;
                document.querySelectorAll('.thumb').forEach((t, i) => {
                    t.classList.toggle('active', i === index);
                });
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }

        async function loadSimilarListings() {
            if (!currentListing) return;
            
            try {
                const { data } = await supabase
                    .from('listings')
                    .select(`
                        id, title, price, created_at, city, district, slug,
                        images:listing_images(image_url, is_primary)
                    `)
                    .eq('category_id', currentListing.category_id)
                    .neq('id', currentListing.id)
                    .eq('status', 'active')
                    .limit(4);

                const container = document.getElementById('similarListings');
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="no-similar">Benzer ilan bulunamadƒ±</p>';
                    return;
                }

                container.innerHTML = data.map(l => {
                    const img = l.images?.find(i => i.is_primary) || l.images?.[0];
                    const imgUrl = img?.image_url || '';
                    const location = l.district && l.city ? `${l.district}, ${l.city}` : l.city || '-';
                    
                    const imageHtml = imgUrl 
                        ? `<div class="similar-image" style="background-image: url('${imgUrl}')"></div>`
                        : `<div class="similar-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">üì∑</div>`;

                    return `
                        <a href="listing-detail.html?slug=${l.slug}" class="similar-card">
                            ${imageHtml}
                            <div class="similar-content">
                                <h4>${l.title}</h4>
                                <p class="similar-location">üìç ${location}</p>
                                <p class="similar-price">‚Ç∫${(l.price || 0).toLocaleString('tr-TR')}</p>
                                <div class="similar-footer">
                                    <span>${new Date(l.created_at).toLocaleDateString('tr-TR')}</span>
                                    <span>Detaylarƒ± g√∂r√ºn ‚Üí</span>
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');

            } catch (e) {
                console.error('Similar listings error:', e);
            }
        }

        function toggleFavorite() {
            alert('Favorilere eklendi!');
        }

        function shareListing() {
            if (navigator.share) {
                navigator.share({
                    title: currentListing?.title,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link kopyalandƒ±!');
            }
        }

        function sendWhatsApp() {
            const phone = currentListing?.owner?.phone?.replace(/\D/g, '');
            if (phone) {
                window.open(`https://wa.me/90${phone}?text=Merhaba, Devredin'deki ilanƒ±nƒ±zla ilgileniyorum.`, '_blank');
            } else {
                alert('Telefon numarasƒ± bulunamadƒ±');
            }
        }

        function callSeller() {
            const phone = currentListing?.owner?.phone;
            if (phone) {
                window.location.href = `tel:${phone}`;
            } else {
                alert('Telefon numarasƒ± bulunamadƒ±');
            }
        }

        function sendOffer() {
            alert('Teklif g√∂nderme √∂zelliƒüi yakƒ±nda eklenecek');
        }

        function viewReport() {
            alert('Rapor g√∂r√ºnt√ºleme √∂zelliƒüi yakƒ±nda eklenecek');
        }

        function openFullscreen() {
            const img = document.getElementById('mainImage');
            if (img.requestFullscreen) {
                img.requestFullscreen();
            }
        }

        function handleContactSubmit(e) {
            e.preventDefault();
            alert('Mesajƒ±nƒ±z g√∂nderildi!');
            e.target.reset();
        }

        // Initialize Google Maps for listing detail
        let detailMap = null;
        let detailMarker = null;

        function initDetailMap(lat, lng, title, city, district) {
            const mapElement = document.getElementById('map');
            if (!mapElement || !lat || !lng) {
                console.log('‚ùå Map element or coordinates missing');
                return;
            }

            try {
                const position = { lat: parseFloat(lat), lng: parseFloat(lng) };
                
                // Initialize map
                detailMap = new google.maps.Map(mapElement, {
                    center: position,
                    zoom: 15,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true,
                    zoomControl: true
                });

                // Add marker
                detailMarker = new google.maps.Marker({
                    position: position,
                    map: detailMap,
                    title: title,
                    animation: google.maps.Animation.DROP
                });

                // Info window with listing details
                const infoContent = `
                    <div style="font-family: Inter, sans-serif; padding: 8px;">
                        <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 14px; font-weight: 600;">${title}</h4>
                        <p style="margin: 0; color: #6b7280; font-size: 12px;">${district ? district + ', ' : ''}${city || ''}</p>
                        <p style="margin: 4px 0 0 0; color: #9ca3af; font-size: 11px;">
                            üìç ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                        </p>
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({
                    content: infoContent
                });

                detailMarker.addListener('click', () => {
                    infoWindow.open(detailMap, detailMarker);
                });

                console.log('‚úÖ Detail map initialized:', position);
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
            }
        }
    </script>
</body>
</html>
