<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞lan Olu≈ütur - Devredin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="add-listing.css?v=21">
</head>
<body>
    <!-- Header -->
    <header class="form-header">
        <a href="index.html" class="header-logo">d.</a>
        
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <span class="step-number">01</span>
                <span class="step-text">Listeleme Bilgileri</span>
            </div>
            <div class="step" data-step="2">
                <span class="step-number">02</span>
                <span class="step-text">ƒ∞≈ületme Ayrƒ±ntƒ±larƒ±</span>
            </div>
            <div class="step" data-step="3">
                <span class="step-number">03</span>
                <span class="step-text">ƒ∞lan Yayƒ±n Detaylarƒ±</span>
            </div>
            <div class="step" data-step="4">
                <span class="step-number">04</span>
                <span class="step-text">Yapay Zeka & √ñnizleme</span>
            </div>
        </div>
        
        <button class="save-exit-btn" onclick="saveAndExit()">Kaydet ve √áƒ±kƒ±≈ü Yap</button>
    </header>

    <!-- Form Content -->
    <main class="form-main">
        <div class="container">
            <!-- Step 1: Listeleme Bilgileri -->
            <div class="form-step active" id="step1">
                <div class="form-grid">
                    <div class="form-left">
                        <div class="form-group">
                            <label>Listeleme ba≈ülƒ±ƒüƒ± <span class="required">*</span></label>
                            <input type="text" id="title" placeholder="√ñrneƒüin; Merkezi Konumlu Cafe, Devren Kiralƒ±k ≈ûark√ºteri...">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Sekt√∂r <span class="required">*</span></label>
                                <div class="custom-select" id="sectorSelect">
                                    <div class="select-trigger" onclick="toggleDropdown('sectorDropdown')">
                                        <span id="sectorValue">L√ºtfen se√ßim yapƒ±n</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                                    </div>
                                    <div class="select-dropdown" id="sectorDropdown">
                                        <input type="text" class="dropdown-search" placeholder="Sekt√∂r ara..." oninput="filterSectors(this.value)">
                                        <div class="dropdown-options" id="sectorOptions">
                                            <!-- Options will be loaded -->
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="categoryId">
                                <input type="hidden" id="subcategoryId">
                            </div>
                            <div class="form-group">
                                <label>Kurulu≈ü yƒ±lƒ±</label>
                                <input type="number" id="establishedYear" placeholder="Kurulu≈ü yƒ±lƒ± yazƒ±n" min="1900" max="2025">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Metrekare <span class="required">*</span></label>
                                <div class="input-with-suffix">
                                    <input type="number" id="area" placeholder="Metrekare yazƒ±n">
                                    <span class="suffix">m¬≤</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ƒ∞stenen fiyat <span class="required">*</span></label>
                                <div class="input-with-suffix">
                                    <input type="number" id="price" placeholder="Fiyat yazƒ±n">
                                    <span class="suffix">‚Ç∫</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Listeleme a√ßƒ±klamasƒ± <span class="required">*</span></label>
                            <div class="rich-editor">
                                <div class="editor-toolbar">
                                    <button type="button" onclick="formatText('bold')"><b>B</b></button>
                                    <button type="button" onclick="formatText('italic')"><i>I</i></button>
                                    <button type="button" onclick="formatText('underline')"><u>U</u></button>
                                    <button type="button" onclick="formatText('h1')">H‚ÇÅ</button>
                                    <button type="button" onclick="formatText('h2')">H‚ÇÇ</button>
                                    <button type="button" onclick="formatText('ul')">‚ò∞</button>
                                    <button type="button" onclick="formatText('ol')">1.</button>
                                </div>
                                <div class="editor-content" id="description" contenteditable="true" placeholder="√ñrneƒüin; Merkezi Konumlu Cafe, Devren Kiralƒ±k ≈ûark√ºteri..."></div>
                            </div>
                            <span class="char-count"><span id="charCount">0</span> / 40 minimum karakter</span>
                        </div>
                    </div>
                    
                    <div class="form-right">
                        <div class="form-group">
                            <label>Adres veya konum girin <span class="required">*</span></label>
                            <div class="location-input-wrapper">
                                <div class="location-input">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <input type="text" id="address" placeholder="≈ûehir, il√ße veya mahalle yazƒ±n..." autocomplete="off">
                                    <!-- Google Places Autocomplete will show its own dropdown -->
                                </div>
                                <!-- Old dropdown removed - Google Autocomplete handles this -->
                                    </div>
                            <!-- Hidden fields for coordinates -->
                            <input type="hidden" id="latitude">
                            <input type="hidden" id="longitude">
                        </div>
                        
                        <div class="form-group">
                            <label>Konum <span class="required">*</span></label>
                            <div id="map" style="height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb;"></div>
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                üí° Haritayƒ± tƒ±klayarak veya pin'i s√ºr√ºkleyerek tam konumu belirleyin
                            </p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Vilayet</label>
                                <input type="text" id="city" placeholder="Konum se√ßildikten sonra otomatik doldurulur" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Semt</label>
                            <input type="text" id="district" placeholder="Konum se√ßildikten sonra otomatik doldurulur" readonly>
                        </div>
                        
                        <!-- OLD IFRAME MAP REMOVED - Using Google Maps API above -->
                    </div>
                </div>
            </div>

            <!-- Step 2: ƒ∞≈ületme Ayrƒ±ntƒ±larƒ± -->
            <div class="form-step" id="step2">
                <!-- Finansal Bilgiler -->
                <div class="accordion-section">
                    <button class="accordion-header active" onclick="toggleAccordion(this)">
                        <span class="accordion-icon">üí∞</span>
                        <span>Finansal Bilgiler</span>
                        <svg class="accordion-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="accordion-content active">
                        <div class="form-row three-col">
                            <div class="form-group">
                                <label>Aylƒ±k gelir</label>
                                <div class="input-with-suffix">
                                    <input type="number" id="monthlyRevenue" placeholder="Aylƒ±k geliri yazƒ±n">
                                    <span class="suffix">‚Ç∫</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Aylƒ±k kar</label>
                                <div class="input-with-suffix">
                                    <input type="number" id="monthlyProfit" placeholder="Aylƒ±k karƒ± yazƒ±n">
                                    <span class="suffix">‚Ç∫</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>√áalƒ±≈üan sayƒ±sƒ±</label>
                                <input type="number" id="employeeCount" placeholder="√áalƒ±≈üan sayƒ±sƒ±nƒ± yazƒ±n">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Satƒ±≈ü t√ºr√º <span class="required">*</span></label>
                                <select id="saleType">
                                    <option value="rent">Devren Kiralƒ±k</option>
                                    <option value="sale">Devren Satƒ±lƒ±k</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Satƒ±≈ü nedeni <span class="required">*</span></label>
                                <select id="saleReason">
                                    <option value="">Satƒ±≈ü sebebi se√ßin</option>
                                    <option value="retirement">Emeklilik</option>
                                    <option value="personal">Ki≈üisel nedenler</option>
                                    <option value="health">Saƒülƒ±k nedenleri</option>
                                    <option value="sector_change">Sekt√∂r deƒüi≈üikliƒüi</option>
                                    <option value="city_change">≈ûehir deƒüi≈üikliƒüi</option>
                                    <option value="abroad">Yurtdƒ±≈üƒ±na ta≈üƒ±nma</option>
                                    <option value="other">Diƒüer</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Aylƒ±k Kira <span class="required">*</span></label>
                                <div class="input-with-suffix">
                                    <input type="number" id="monthlyRent" placeholder="Aylƒ±k kirayƒ± yazƒ±n">
                                    <span class="suffix">‚Ç∫</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>S√∂zle≈üme Biti≈ü Tarihi</label>
                                <div class="custom-date-picker">
                                    <div class="date-input" onclick="toggleDatePicker()">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                        </svg>
                                        <span id="selectedDate">Ay ve yƒ±l se√ßin</span>
                                        <svg class="dropdown-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                                    </div>
                                    <div class="date-dropdown" id="dateDropdown">
                                        <div class="date-picker-header">
                                            <button type="button" onclick="changeYear(-1)">‚Äπ</button>
                                            <span id="currentYear">2024</span>
                                            <button type="button" onclick="changeYear(1)">‚Ä∫</button>
                                        </div>
                                        <div class="month-grid">
                                            <div class="month-item" onclick="selectMonth(0)">Ocak</div>
                                            <div class="month-item" onclick="selectMonth(1)">≈ûubat</div>
                                            <div class="month-item" onclick="selectMonth(2)">Mart</div>
                                            <div class="month-item" onclick="selectMonth(3)">Nisan</div>
                                            <div class="month-item" onclick="selectMonth(4)">Mayƒ±s</div>
                                            <div class="month-item" onclick="selectMonth(5)">Haziran</div>
                                            <div class="month-item" onclick="selectMonth(6)">Temmuz</div>
                                            <div class="month-item" onclick="selectMonth(7)">Aƒüustos</div>
                                            <div class="month-item" onclick="selectMonth(8)">Eyl√ºl</div>
                                            <div class="month-item" onclick="selectMonth(9)">Ekim</div>
                                            <div class="month-item" onclick="selectMonth(10)">Kasƒ±m</div>
                                            <div class="month-item" onclick="selectMonth(11)">Aralƒ±k</div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="leaseEndDate">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Eƒüitim, Satƒ±≈ü Sonrasƒ± Danƒ±≈ümanlƒ±k ve Destek <span class="required">*</span></label>
                                <select id="trainingSupport">
                                    <option value="no">Hayƒ±r</option>
                                    <option value="yes">Evet</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Franchise mƒ±? <span class="required">*</span></label>
                                <select id="isFranchise">
                                    <option value="no">Hayƒ±r</option>
                                    <option value="yes">Evet</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Diƒüer Bilgiler -->
                <div class="accordion-section">
                    <button class="accordion-header" onclick="toggleAccordion(this)">
                        <span class="accordion-icon">‚ÑπÔ∏è</span>
                        <span>Diƒüer Bilgiler</span>
                        <span class="optional-badge">Opsiyonel</span>
                        <svg class="accordion-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Envanter Deƒüeri</label>
                                <div class="input-with-suffix">
                                    <input type="number" id="inventoryValue" placeholder="Envanter deƒüerini yazƒ±n">
                                    <span class="suffix">‚Ç∫</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Ekipman Deƒüeri</label>
                                <div class="input-with-suffix">
                                    <input type="number" id="equipmentValue" placeholder="Ekipman deƒüerini yazƒ±n">
                                    <span class="suffix">‚Ç∫</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row three-col">
                            <div class="form-group">
                                <label>Instagram URL'si</label>
                                <input type="url" id="instagramUrl" placeholder="https://instagram.com/kullaniciadi">
                            </div>
                            <div class="form-group">
                                <label>Google Haritalar URL'si</label>
                                <input type="url" id="googleMapsUrl" placeholder="https://maps.google.com/...">
                            </div>
                            <div class="form-group">
                                <label>Web Sitesi URL'si</label>
                                <input type="url" id="websiteUrl" placeholder="https://ornek.com">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: ƒ∞lan Yayƒ±n Detaylarƒ± -->
            <div class="form-step" id="step3">
                <div class="upload-grid">
                    <div class="upload-card">
                        <h3>Kapak G√∂rseli <span class="required">*</span></h3>
                        <p class="upload-desc">ƒ∞lanƒ±nƒ±z i√ßin bir kapak resmi y√ºkleyin.</p>
                        <div class="upload-preview" id="coverPreview">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <span>Kapak g√∂rseli y√ºklenmedi</span>
                        </div>
                        <div class="upload-area" onclick="document.getElementById('coverImage').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <span>Buraya tƒ±klayƒ±n veya dosyalarƒ± s√ºr√ºkleyin</span>
                            <small>PNG, JPG maks. 24MB</small>
                        </div>
                        <input type="file" id="coverImage" accept="image/*" hidden onchange="previewCover(this)">
                    </div>
                    
                    <div class="upload-card">
                        <h3>Tanƒ±tƒ±m D√∂k√ºmanƒ±</h3>
                        <p class="upload-desc">Tanƒ±tƒ±m d√∂k√ºmanƒ± ekleyin.</p>
                        <div class="upload-preview" id="docPreview">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span>D√∂k√ºman y√ºklenmedi</span>
                        </div>
                        <div class="upload-area" onclick="document.getElementById('document').click()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span>Buraya tƒ±klayƒ±n veya dosyalarƒ± s√ºr√ºkleyin</span>
                            <small>PDF maks. 100MB</small>
                        </div>
                        <input type="file" id="document" accept=".pdf" hidden onchange="previewDocument(this)">
                    </div>
                    
                    <div class="upload-card wide">
                        <h3>ƒ∞lan G√∂rselleri</h3>
                        <p class="upload-desc">ƒ∞lanƒ±nƒ±zla ilgili bir tanƒ±tƒ±m belgesi y√ºkleyin.</p>
                        <div class="gallery-upload">
                            <div class="gallery-slots" id="gallerySlots">
                                <!-- 8 slots for images -->
                            </div>
                            <div class="upload-area" onclick="document.getElementById('galleryImages').click()">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <span>Buraya tƒ±klayƒ±n veya dosyalarƒ± s√ºr√ºkleyin</span>
                                <small>PNG, JPG, GIF (maks. 20 MB)</small>
                            </div>
                        </div>
                        <input type="file" id="galleryImages" accept="image/*" multiple hidden onchange="handleGalleryUpload(this)">
                    </div>
                </div>
            </div>

            <!-- Step 4: Yapay Zeka & √ñnizleme -->
            <div class="form-step" id="step4">
                <div class="preview-grid">
                    <div class="ai-section">
                        <div class="ai-header">
                            <span class="ai-icon">‚ú®</span>
                            <div>
                                <h3>Yapay Zeka ƒ∞yile≈ütirmeleri</h3>
                                <p>Ba≈ülƒ±ƒüƒ±nƒ±zƒ± ve a√ßƒ±klamanƒ±zƒ± yapay zeka ile geli≈ütirin.</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Listeleme ba≈ülƒ±ƒüƒ± <span class="required">*</span></label>
                            <input type="text" id="aiTitle" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Listeleme a√ßƒ±klamasƒ± <span class="required">*</span></label>
                            <div class="rich-editor readonly">
                                <div class="editor-toolbar">
                                    <button type="button"><b>B</b></button>
                                    <button type="button"><i>I</i></button>
                                    <button type="button"><u>U</u></button>
                                    <button type="button">H‚ÇÅ</button>
                                    <button type="button">H‚ÇÇ</button>
                                    <button type="button">‚ò∞</button>
                                    <button type="button">1.</button>
                                </div>
                                <div class="editor-content" id="aiDescription"></div>
                            </div>
                        </div>
                        
                        <div class="ai-actions">
                            <button class="btn btn-primary" onclick="approveAI()">Onayla</button>
                            <button class="btn btn-outline" onclick="rejectAI()">ƒ∞ptal Et</button>
                            <span class="ai-note">*Yapay zeka √∂nerileri yalnƒ±zca yardƒ±mcƒ± niteliktedir. ƒ∞lanƒ±n yayƒ±mlanan metni ve i√ßerikten doƒüabilecek sonu√ßlar kullanƒ±cƒ± tarafƒ±ndan onaylanmƒ±≈ü sayƒ±lƒ±r.</span>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <div class="preview-header">
                            <span class="preview-icon">üìã</span>
                            <div>
                                <h3>Listeleme √ñnizlemesi</h3>
                                <p>Hazƒ±rladƒ±ƒüƒ±nƒ±z ilan i√ßin √∂nizleme ger√ßekle≈ütirin.</p>
                            </div>
                        </div>
                        
                        <div class="preview-cards" id="previewCards">
                            <!-- Preview cards will be generated -->
                        </div>
                        
                        <button class="btn btn-preview" onclick="openPreview()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            √ñnizlemeyi G√∂r√ºnt√ºle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Navigation -->
    <footer class="form-footer">
        <div class="container">
            <button class="btn btn-back" id="backBtn" onclick="prevStep()" style="display:none;">
                ‚Üê Geri D√∂n
            </button>
            <div class="footer-right">
                <button class="btn btn-secondary" id="sellWithBtn" style="display:none;" onclick="sellWith()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    Devredin ile Sat
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">Devam Et</button>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 25%;"></div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="backend/api.js"></script>
    <script>
        // Global flag for Google Maps API readiness
        window.googleMapsLoaded = false;
        
        function initGoogleMaps() {
            console.log('‚úÖ Google Maps API loaded!');
            window.googleMapsLoaded = true;
            // Try to initialize map if DOM is ready
            if (window.initMapWhenReady) {
                window.initMapWhenReady();
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC4r_aAIPvRAEGPqARc-Y9s-UstldmSqk&libraries=places&language=tr&callback=initGoogleMaps" async defer></script>
    <script>
        let currentStep = 1;
        const totalSteps = 4;
        let galleryImages = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            initGallerySlots();
            updateDescription();
            setupValidationListeners();
            checkStepValidity();
            
            // Setup map initialization function
            window.initMapWhenReady = function() {
                if (typeof google !== 'undefined' && google.maps) {
                    initMap();
                }
            };
            
            // Try to init map if Google API is already loaded
            if (window.googleMapsLoaded) {
                window.initMapWhenReady();
            }
        });

        // Load categories
        async function loadCategories() {
            try {
                const { data: categories } = await supabase
                    .from('categories')
                    .select('id, name, parent_id')
                    .order('name');
                
                if (categories) {
                    const optionsEl = document.getElementById('sectorOptions');
                    const mainCats = categories.filter(c => !c.parent_id);
                    
                    let html = '';
                    mainCats.forEach(cat => {
                        html += `<div class="option-group"><div class="option-header">${cat.name}</div>`;
                        const subs = categories.filter(c => c.parent_id === cat.id);
                        subs.forEach(sub => {
                            html += `<div class="option" onclick="selectSector('${cat.id}', '${sub.id}', '${sub.name}')">${sub.name}</div>`;
                        });
                        if (subs.length === 0) {
                            html += `<div class="option" onclick="selectSector('${cat.id}', '', '${cat.name}')">${cat.name}</div>`;
                        }
                        html += '</div>';
                    });
                    optionsEl.innerHTML = html;
                }
            } catch (e) {
                console.error('Categories load error:', e);
            }
        }

        // Dropdown functions
        function toggleDropdown(id) {
            document.getElementById(id).classList.toggle('active');
        }

        function selectSector(catId, subId, name) {
            document.getElementById('categoryId').value = catId;
            document.getElementById('subcategoryId').value = subId;
            document.getElementById('sectorValue').textContent = name;
            document.getElementById('sectorDropdown').classList.remove('active');
            checkStepValidity();
        }

        function filterSectors(query) {
            const options = document.querySelectorAll('#sectorOptions .option');
            options.forEach(opt => {
                opt.style.display = opt.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // Location search with autocomplete
        // OLD: let locationData = []; - No longer needed with Google Places API
        // OLD: let searchTimeout = null; - No longer needed
        
        // OLD LOCATION DATA LOADING - NO LONGER NEEDED WITH GOOGLE PLACES
        // Google Places API has comprehensive location data built-in
        /*
        async function loadLocationData() {
            // Not needed - Google Places handles this
        }
        */
        
        // ========== GOOGLE MAPS INTEGRATION ==========
        
        // Initialize interactive map with Google Maps
        let map = null;
        let mapMarker = null;
        let autocomplete = null;
        let geocoder = null;
        
        function initMap() {
            console.log('üó∫Ô∏è Initializing Google Maps...');
            console.log('google object:', typeof google);
            console.log('google.maps:', typeof google?.maps);
            
            // Default center: Istanbul
            const defaultLat = 41.0082;
            const defaultLng = 28.9784;
            
            // Create map
            const mapElement = document.getElementById('map');
            console.log('Map element:', mapElement);
            
            map = new google.maps.Map(mapElement, {
                center: { lat: defaultLat, lng: defaultLng },
                zoom: 11,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false,
                zoomControl: true
            });
            window.map = map;
            
            // Create geocoder
            geocoder = new google.maps.Geocoder();
            
            // Create draggable marker
            mapMarker = new google.maps.Marker({
                position: { lat: defaultLat, lng: defaultLng },
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP
            });
            window.mapMarker = mapMarker;
            
            // Handle map click - move marker
            map.addListener('click', function(e) {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();
                mapMarker.setPosition(e.latLng);
                updateLocationFromCoordinates(lat, lng);
            });
            
            // Handle marker drag - update location
            mapMarker.addListener('dragend', function(e) {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();
                updateLocationFromCoordinates(lat, lng);
            });
            
            // Setup Google Places Autocomplete for the search input
            const input = document.getElementById('address');
            autocomplete = new google.maps.places.Autocomplete(input, {
                componentRestrictions: { country: 'tr' },
                fields: ['address_components', 'geometry', 'formatted_address', 'name']
            });
            
            // Handle place selection from autocomplete
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                
                if (!place.geometry) {
                    console.log('No details available for input:', input.value);
                return;
            }
            
                // Get coordinates
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                
                // Update map
                map.setCenter(place.geometry.location);
                map.setZoom(15);
                mapMarker.setPosition(place.geometry.location);
                
                // Parse address components
                let city = '';
                let district = '';
                let neighborhood = '';
                
                console.log('üìç Address components:', place.address_components);
                
                place.address_components.forEach(component => {
                    console.log('Component:', component.long_name, 'Types:', component.types);
                    
                    // ƒ∞l (Province/City)
                    if (component.types.includes('administrative_area_level_1')) {
                        city = component.long_name;
                    }
                    // ƒ∞l√ße (District/Town)
                    if (component.types.includes('administrative_area_level_2')) {
                        district = component.long_name;
                    }
                    // Alternatif: locality (≈üehir merkezi)
                    if (!city && component.types.includes('locality')) {
                        city = component.long_name;
                    }
                    // Alternatif: sublocality (semt/mahalle)
                    if (!district && (component.types.includes('sublocality') || component.types.includes('sublocality_level_1'))) {
                        district = component.long_name;
                    }
                    // Mahalle
                    if (component.types.includes('neighborhood')) {
                        neighborhood = component.long_name;
                    }
                });
                
                // Eƒüer district bo≈üsa neighborhood'u kullan
                if (!district && neighborhood) {
                    district = neighborhood;
                }
                
                console.log('üèôÔ∏è Parsed location:', { city, district, neighborhood });
                
                // Update fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
                document.getElementById('city').value = city;
                document.getElementById('district').value = district;
                
                // Store location data
                window.selectedLocation = {
                    city: city,
                    district: district,
                    lat: lat,
                    lng: lng
                };
                
            checkStepValidity();
                
                console.log('‚úÖ Location selected:', { city, district, lat, lng });
            });
            
            console.log('‚úÖ Google Maps initialized with autocomplete');
        }
        
        // Reverse geocoding - get address from coordinates using Google Geocoder
        async function updateLocationFromCoordinates(lat, lng) {
            try {
                // Update hidden fields immediately
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                
                // Use Google Geocoder for reverse geocoding
                geocoder.geocode({ location: { lat, lng } }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        const place = results[0];
                        
                        // Parse address components
                        let city = '';
                        let district = '';
                        let neighborhood = '';
                        
                        place.address_components.forEach(component => {
                            if (component.types.includes('administrative_area_level_1')) {
                                city = component.long_name;
                            }
                            if (component.types.includes('administrative_area_level_2')) {
                                district = component.long_name;
                            }
                            if (component.types.includes('sublocality') || component.types.includes('neighborhood')) {
                                neighborhood = component.long_name;
                            }
                        });
                        
                        // Build display name
                        let displayParts = [];
                        if (neighborhood) displayParts.push(neighborhood);
                        if (district && district !== neighborhood) displayParts.push(district);
                        if (city) displayParts.push(city);
                        const displayName = displayParts.join(', ');
                        
                        // Update input fields
                        document.getElementById('address').value = displayName;
                        document.getElementById('city').value = city;
                        document.getElementById('district').value = district;
                        
                        // Store location data
                        window.selectedLocation = {
                            city: city,
                            district: district,
                            lat: lat,
                            lng: lng
                        };
                        
                        checkStepValidity();
                        
                        console.log('‚úÖ Reverse geocoding:', { city, district, displayName });
                    } else {
                        console.error('‚ùå Reverse geocoding failed:', status);
                    }
                });
            } catch (error) {
                console.error('‚ùå Reverse geocoding error:', error);
            }
        }
        
        // OLD selectLocation function removed - Google Autocomplete handles everything

        // Accordion
        function toggleAccordion(btn) {
            btn.classList.toggle('active');
            btn.nextElementSibling.classList.toggle('active');
        }

        // Rich editor
        function formatText(format) {
            document.execCommand(format === 'h1' ? 'formatBlock' : format === 'h2' ? 'formatBlock' : format, false, format === 'h1' ? 'h1' : format === 'h2' ? 'h2' : null);
        }

        function updateDescription() {
            const desc = document.getElementById('description');
            desc.addEventListener('input', () => {
                document.getElementById('charCount').textContent = desc.textContent.length;
            });
        }

        // Gallery
        function initGallerySlots() {
            const container = document.getElementById('gallerySlots');
            let html = '';
            for (let i = 0; i < 8; i++) {
                html += `<div class="gallery-slot" id="slot${i}"><span>+</span></div>`;
            }
            container.innerHTML = html;
        }

        function handleGalleryUpload(input) {
            const files = Array.from(input.files);
            files.forEach((file, i) => {
                if (galleryImages.length < 8) {
                    galleryImages.push(file);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const slot = document.getElementById(`slot${galleryImages.length - 1}`);
                        slot.innerHTML = `<img src="${e.target.result}" alt="Image">`;
                        slot.classList.add('filled');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function previewCover(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('coverPreview').innerHTML = `<img src="${e.target.result}" alt="Cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewDocument(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const preview = document.getElementById('docPreview');
                preview.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    <span style="color: #10b981; font-weight: 500;">${file.name}</span>
                    <small style="color: #6b7280;">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                `;
            }
        }

        // Step navigation
        function nextStep() {
            if (currentStep < totalSteps) {
                if (validateStep(currentStep)) {
                    const activeStep = document.querySelector(`.form-step.active`);
                    const activeProgress = document.querySelector(`[data-step="${currentStep}"]`);
                    
                    if (activeStep) activeStep.classList.remove('active');
                    if (activeProgress) {
                        activeProgress.classList.remove('active');
                        activeProgress.classList.add('completed');
                    }
                    
                    currentStep++;
                    
                    const nextStepEl = document.getElementById(`step${currentStep}`);
                    const nextProgress = document.querySelector(`[data-step="${currentStep}"]`);
                    
                    if (nextStepEl) nextStepEl.classList.add('active');
                    if (nextProgress) nextProgress.classList.add('active');
                    
                    updateNavigation();
                    
                    if (currentStep === 4) {
                        generatePreview();
                    }
                }
            } else {
                submitListing();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                const activeStep = document.querySelector(`.form-step.active`);
                const activeProgress = document.querySelector(`[data-step="${currentStep}"]`);
                
                if (activeStep) activeStep.classList.remove('active');
                if (activeProgress) activeProgress.classList.remove('active');
                
                currentStep--;
                
                const prevStepEl = document.getElementById(`step${currentStep}`);
                const prevProgress = document.querySelector(`[data-step="${currentStep}"]`);
                
                if (prevStepEl) prevStepEl.classList.add('active');
                if (prevProgress) prevProgress.classList.add('active');
                
                updateNavigation();
            }
        }

        function updateNavigation() {
            document.getElementById('backBtn').style.display = currentStep > 1 ? '' : 'none';
            document.getElementById('progressFill').style.width = `${(currentStep / totalSteps) * 100}%`;
            
            if (currentStep === 4) {
                document.getElementById('nextBtn').textContent = 'ƒ∞lanƒ± Yayƒ±nla';
                document.getElementById('sellWithBtn').style.display = '';
            } else {
                document.getElementById('nextBtn').textContent = 'Devam Et';
                document.getElementById('sellWithBtn').style.display = 'none';
            }
            
            checkStepValidity();
        }

        function checkStepValidity() {
            const btn = document.getElementById('nextBtn');
            const isValid = validateStepFields(currentStep);
            
            if (isValid) {
                btn.classList.remove('disabled');
                btn.disabled = false;
            } else {
                btn.classList.add('disabled');
                btn.disabled = true;
            }
        }

        function validateStepFields(step) {
            if (step === 1) {
                const title = document.getElementById('title')?.value.trim();
                const category = document.getElementById('categoryId')?.value;
                const area = document.getElementById('area')?.value;
                const price = document.getElementById('price')?.value;
                const desc = document.getElementById('description')?.textContent.trim();
                const city = document.getElementById('city')?.value; // Changed from cityId to city
                const lat = document.getElementById('latitude')?.value;
                const lng = document.getElementById('longitude')?.value;
                
                console.log('üîç Step 1 validation:', { title, category, area, price, descLength: desc.length, city, lat, lng });
                
                return title && title.length > 0 && category && area && price && desc && desc.length >= 40 && city && lat && lng;
            }
            if (step === 2) {
                const saleReason = document.getElementById('saleReason')?.value;
                const monthlyRent = document.getElementById('monthlyRent')?.value;
                
                return saleReason && monthlyRent;
            }
            if (step === 3) {
                const coverInput = document.getElementById('coverImage');
                const cover = coverInput ? coverInput.files.length > 0 : false;
                return cover;
            }
            return true;
        }

        function validateStep(step) {
            const errors = [];
            
            if (step === 1) {
                const title = document.getElementById('title')?.value.trim();
                const category = document.getElementById('categoryId')?.value;
                const area = document.getElementById('area')?.value;
                const price = document.getElementById('price')?.value;
                const desc = document.getElementById('description')?.textContent.trim();
                const city = document.getElementById('city')?.value; // Changed from cityId
                const lat = document.getElementById('latitude')?.value;
                const lng = document.getElementById('longitude')?.value;
                
                if (!title) errors.push('Listeleme ba≈ülƒ±ƒüƒ±');
                if (!category) errors.push('Sekt√∂r');
                if (!area) errors.push('Metrekare');
                if (!price) errors.push('ƒ∞stenen fiyat');
                if (!desc || desc.length < 40) errors.push('Listeleme a√ßƒ±klamasƒ± (min. 40 karakter)');
                if (!city || !lat || !lng) errors.push('Konum');
            }
            
            if (step === 2) {
                const saleReason = document.getElementById('saleReason')?.value;
                const monthlyRent = document.getElementById('monthlyRent')?.value;
                
                if (!saleReason) errors.push('Satƒ±≈ü nedeni');
                if (!monthlyRent) errors.push('Aylƒ±k Kira');
            }
            
            if (step === 3) {
                const coverInput = document.getElementById('coverImage');
                const cover = coverInput ? coverInput.files.length > 0 : false;
                if (!cover) errors.push('Kapak g√∂rseli');
            }
            
            if (errors.length > 0) {
                highlightErrors(errors);
                showErrorMessage(errors);
                return false;
            }
            
            return true;
        }
        
        function highlightErrors(errors) {
            // Remove previous error highlights
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
            
            // Add error class to invalid fields
            const fieldMap = {
                'Listeleme ba≈ülƒ±ƒüƒ±': 'title',
                'Sekt√∂r': 'sectorSelect',
                'Metrekare': 'area',
                'ƒ∞stenen fiyat': 'price',
                'Listeleme a√ßƒ±klamasƒ± (min. 40 karakter)': 'description',
                'Konum': 'address',
                'Satƒ±≈ü nedeni': 'saleReason',
                'Aylƒ±k Kira': 'monthlyRent',
                'Kapak g√∂rseli': 'coverPreview'
            };
            
            errors.forEach(err => {
                const fieldId = fieldMap[err];
                if (fieldId) {
                    const el = document.getElementById(fieldId);
                    if (el) {
                        el.classList.add('field-error');
                        const parent = el.closest('.form-group');
                        if (parent) parent.classList.add('has-error');
                    }
                }
            });
        }
        
        function showErrorMessage(errors) {
            const message = `L√ºtfen a≈üaƒüƒ±daki zorunlu alanlarƒ± doldurun:\n\n‚Ä¢ ${errors.join('\n‚Ä¢ ')}`;
            alert(message);
        }
        
        // Real-time validation listeners
        function setupValidationListeners() {
            const step1Fields = ['title', 'area', 'price', 'description', 'address'];
            const step2Fields = ['saleReason', 'monthlyRent'];
            
            step1Fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', checkStepValidity);
                    el.addEventListener('change', checkStepValidity);
                }
            });
            
            step2Fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', checkStepValidity);
                    el.addEventListener('change', checkStepValidity);
                }
            });
            
            // Cover image
            document.getElementById('coverImage').addEventListener('change', checkStepValidity);
        }

        // Generate preview
        function generatePreview() {
            const title = document.getElementById('title').value;
            const price = document.getElementById('price').value;
            const desc = document.getElementById('description').innerHTML;
            
            document.getElementById('aiTitle').value = title;
            document.getElementById('aiDescription').innerHTML = desc;
            
            document.getElementById('previewCards').innerHTML = `
                <div class="preview-card">
                    <div class="preview-image"></div>
                    <div class="preview-info">
                        <span class="preview-type">Devren Kiralƒ±k</span>
                        <span class="preview-category">Yeme - ƒ∞√ßme</span>
                    </div>
                    <h4>${title || 'ƒ∞lan Ba≈ülƒ±ƒüƒ±'}</h4>
                    <p class="preview-location">Konum</p>
                    <p class="preview-price">‚Ç∫${parseInt(price || 0).toLocaleString('tr-TR')}</p>
                </div>
            `;
        }

        function approveAI() {
            alert('Yapay zeka √∂nerileri onaylandƒ±!');
        }

        function rejectAI() {
            document.getElementById('aiTitle').value = document.getElementById('title').value;
            document.getElementById('aiDescription').innerHTML = document.getElementById('description').innerHTML;
        }

        function openPreview() {
            alert('√ñnizleme a√ßƒ±lƒ±yor...');
        }

        function saveAndExit() {
            alert('Taslak kaydedildi!');
            window.location.href = 'index.html';
        }

        function sellWith() {
            alert('Devredin ile Sat se√ßeneƒüi i√ßin bizimle ileti≈üime ge√ßin.');
        }

        async function submitListing() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('L√ºtfen giri≈ü yapƒ±n');
                    window.location.href = 'login.html';
                    return;
                }

                // Get user profile for contact info - with fallback
                let contactName = user.email.split('@')[0];
                let contactPhone = '5000000000';
                
                try {
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('full_name, phone')
                        .eq('id', user.id)
                        .single();
                    
                    if (profile?.full_name) contactName = profile.full_name;
                    if (profile?.phone) contactPhone = profile.phone;
                } catch (e) {
                    // Try users table
                    try {
                        const { data: userData } = await supabase
                            .from('users')
                            .select('full_name, phone')
                            .eq('id', user.id)
                            .single();
                        
                        if (userData?.full_name) contactName = userData.full_name;
                        if (userData?.phone) contactPhone = userData.phone;
                    } catch (e2) {
                        console.log('Using default contact info');
                    }
                }

                const title = document.getElementById('aiTitle').value || document.getElementById('title').value;
                const slug = title.toLowerCase()
                    .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                    .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                    .replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '')
                    + '-' + Date.now();
                
                // Ensure contact info is never null
                const finalContactName = contactName || user.email.split('@')[0] || 'Kullanƒ±cƒ±';
                const finalContactPhone = contactPhone || '5000000000';
                
                console.log('Contact info:', { finalContactName, finalContactPhone, email: user.email });
                
                const listingData = {
                    user_id: user.id,
                    title: title,
                    slug: slug,
                    description: document.getElementById('aiDescription')?.innerHTML || document.getElementById('description')?.innerHTML || '',
                    price: parseInt(document.getElementById('price')?.value) || 0,
                    category_id: document.getElementById('categoryId')?.value || null,
                    city: document.getElementById('city')?.value || null,
                    district: document.getElementById('district')?.value || null,
                    address: document.getElementById('address')?.value || null,
                    latitude: parseFloat(document.getElementById('latitude')?.value) || null,
                    longitude: parseFloat(document.getElementById('longitude')?.value) || null,
                    area_sqm: parseInt(document.getElementById('area')?.value) || null,
                    monthly_rent: parseInt(document.getElementById('monthlyRent')?.value) || null,
                    monthly_revenue: parseInt(document.getElementById('monthlyRevenue')?.value) || null,
                    monthly_profit: parseInt(document.getElementById('monthlyProfit')?.value) || null,
                    employee_count: parseInt(document.getElementById('employeeCount')?.value) || null,
                    establishment_year: parseInt(document.getElementById('establishedYear')?.value) || null,
                    is_franchise: document.getElementById('isFranchise')?.value === 'yes',
                    inventory_value: parseInt(document.getElementById('inventoryValue')?.value) || null,
                    equipment_value: parseInt(document.getElementById('equipmentValue')?.value) || null,
                    lease_end_date: document.getElementById('leaseEndDate')?.value || null,
                    includes_training: document.getElementById('trainingSupport')?.value === 'yes',
                    transfer_reason: document.getElementById('saleReason')?.value || null,
                    contact_name: finalContactName,
                    contact_phone: finalContactPhone,
                    contact_email: user.email,
                    status: 'pending'
                };
                
                console.log('Listing data:', listingData);

                const { data, error } = await supabase
                    .from('listings')
                    .insert([listingData])
                    .select()
                    .single();

                if (error) throw error;

                console.log('ƒ∞lan olu≈üturuldu:', data);

                // Upload cover image
                const coverFile = document.getElementById('coverImage').files[0];
                if (coverFile) {
                    try {
                        const fileExt = coverFile.name.split('.').pop();
                        const fileName = `${data.id}-cover-${Date.now()}.${fileExt}`;
                        
                        const { data: uploadData, error: uploadError } = await supabase.storage
                            .from('listing-images')
                            .upload(fileName, coverFile);

                        if (!uploadError) {
                            const { data: { publicUrl } } = supabase.storage
                                .from('listing-images')
                                .getPublicUrl(fileName);
                            
                            await supabase.from('listing_images').insert({
                                listing_id: data.id,
                                image_url: publicUrl,
                                is_primary: true,
                                display_order: 0
                            });
                            
                            console.log('Kapak resmi y√ºklendi');
                        }
                    } catch (e) {
                        console.error('Kapak resmi y√ºkleme hatasƒ±:', e);
                    }
                }

                // Upload gallery images
                if (galleryImages.length > 0) {
                    for (let i = 0; i < galleryImages.length; i++) {
                        try {
                            const file = galleryImages[i];
                            const fileExt = file.name.split('.').pop();
                            const fileName = `${data.id}-gallery-${i}-${Date.now()}.${fileExt}`;
                            
                            const { data: uploadData, error: uploadError } = await supabase.storage
                                .from('listing-images')
                                .upload(fileName, file);

                            if (!uploadError) {
                                const { data: { publicUrl } } = supabase.storage
                                    .from('listing-images')
                                    .getPublicUrl(fileName);
                                
                                await supabase.from('listing_images').insert({
                                    listing_id: data.id,
                                    image_url: publicUrl,
                                    is_primary: false,
                                    display_order: i + 1
                                });
                            }
                        } catch (e) {
                            console.error('Galeri resmi y√ºkleme hatasƒ±:', e);
                        }
                    }
                    console.log(`${galleryImages.length} galeri resmi y√ºklendi`);
                }

                // Upload document (PDF)
                const documentFile = document.getElementById('document').files[0];
                if (documentFile) {
                    try {
                        const fileExt = documentFile.name.split('.').pop();
                        const fileName = `${data.id}-document-${Date.now()}.${fileExt}`;
                        
                        const { data: uploadData, error: uploadError } = await supabase.storage
                            .from('listings')
                            .upload(fileName, documentFile);

                        if (!uploadError) {
                            const { data: { publicUrl } } = supabase.storage
                                .from('listings')
                                .getPublicUrl(fileName);
                            
                            // PDF URL'sini listings tablosuna kaydet (yeni bir column eklemek gerekebilir)
                            await supabase.from('listings').update({
                                document_url: publicUrl
                            }).eq('id', data.id);
                            
                            console.log('D√∂k√ºman y√ºklendi');
                        }
                    } catch (e) {
                        console.error('D√∂k√ºman y√ºkleme hatasƒ±:', e);
                    }
                }

                alert('ƒ∞lanƒ±nƒ±z ba≈üarƒ±yla olu≈üturuldu! Onay s√ºrecinden sonra yayƒ±nlanacaktƒ±r.');
                window.location.href = 'listings.html';

            } catch (e) {
                console.error('Submit error:', e);
                alert('Hata: ' + e.message);
            }
        }

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('active'));
            }
            // locationDropdown removed - Google Autocomplete handles this
            if (!e.target.closest('.custom-date-picker')) {
                const dateDropdown = document.getElementById('dateDropdown');
                if (dateDropdown) dateDropdown.classList.remove('active');
            }
        });

        // Date picker functions
        let selectedYear = new Date().getFullYear();
        let selectedMonth = null;

        function toggleDatePicker() {
            document.getElementById('dateDropdown').classList.toggle('active');
            document.getElementById('currentYear').textContent = selectedYear;
        }

        function changeYear(direction) {
            selectedYear += direction;
            document.getElementById('currentYear').textContent = selectedYear;
        }

        function selectMonth(month) {
            selectedMonth = month;
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                               'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            
            const displayText = `${monthNames[month]} ${selectedYear}`;
            document.getElementById('selectedDate').textContent = displayText;
            document.getElementById('selectedDate').style.color = '#374151';
            
            // Format as YYYY-MM-DD (PostgreSQL DATE format - use first day of month)
            const formattedMonth = String(month + 1).padStart(2, '0');
            document.getElementById('leaseEndDate').value = `${selectedYear}-${formattedMonth}-01`;
            
            document.getElementById('dateDropdown').classList.remove('active');
        }
    </script>
</body>
</html>
